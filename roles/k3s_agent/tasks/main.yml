---
- name: Install iptables on Debian-based systems
  ansible.builtin.apt:
    name:
      - iptables
    state: present
    update_cache: true
  when: ansible_facts['os_family'] == "Debian"

- name: Install iptables on RHEL-based systems
  ansible.builtin.dnf:
    name:
      - iptables
    state: present
  when: ansible_facts['os_family'] == "RedHat"

- name: Check if firewalld is running (RHEL)
  ansible.builtin.systemd:
    name: firewalld
  register: firewalld_status
  when: ansible_facts['os_family'] == "RedHat"

- name: Add trusted networks to firewalld (RHEL)
  ansible.posix.firewalld:
    source: "{{ item }}"
    zone: trusted
    state: enabled
    permanent: true
    immediate: true
  loop: "{{ k3s_trusted_networks }}"
  when:
    - ansible_facts['os_family'] == "RedHat"
    - firewalld_status.status.ActiveState == "active"

- name: Check if k3s-agent service is configured
  ansible.builtin.stat:
    path: /etc/systemd/system/k3s-agent.service
  register: k3s_agent_service_file

- name: Check if k3s-agent uninstall script exists
  ansible.builtin.stat:
    path: /usr/local/bin/k3s-agent-uninstall.sh
  register: k3s_uninstall_script

- name: Check k3s-agent service status
  ansible.builtin.systemd:
    name: k3s-agent
  register: k3s_agent_service
  when: k3s_agent_service_file.stat.exists

- name: Stop broken k3s-agent if not active
  ansible.builtin.systemd:
    name: k3s-agent
    state: stopped
  when:
    - k3s_agent_service_file.stat.exists
    - k3s_agent_service.status.ActiveState is defined
    - k3s_agent_service.status.ActiveState != 'active'

- name: Uninstall broken k3s if service not healthy
  ansible.builtin.shell: /usr/local/bin/k3s-agent-uninstall.sh
  when:
    - k3s_uninstall_script.stat.exists
    - k3s_agent_service_file.stat.exists
    - k3s_agent_service.status.ActiveState is defined
    - k3s_agent_service.status.ActiveState != 'active'

- name: Recheck if k3s-agent service exists after potential uninstall
  ansible.builtin.stat:
    path: /etc/systemd/system/k3s-agent.service
  register: k3s_agent_service_file

- name: Install k3s agent with native snapshotter
  ansible.builtin.shell: |
    curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="--snapshotter=native" K3S_URL={{ k3s_server_url }} K3S_TOKEN={{ k3s_token }} sh -
  when: not k3s_agent_service_file.stat.exists

- name: Wait for k3s-agent service to be active
  ansible.builtin.systemd:
    name: k3s-agent
    state: started
    enabled: true
    daemon_reload: true
  register: k3s_agent_started
  retries: 12
  delay: 10
  until: k3s_agent_started.status.ActiveState == 'active'

- name: Display k3s agent status
  ansible.builtin.debug:
    msg: "k3s-agent service is {{ k3s_agent_started.status.ActiveState }}"
