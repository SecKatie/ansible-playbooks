---
- name: Add Headlamp Helm repository
  ansible.builtin.command:
    cmd: helm repo add {{ headlamp_helm_repo_name }} {{ headlamp_helm_repo_url }}
  register: repo_add
  changed_when: "'has been added' in repo_add.stdout"
  failed_when: repo_add.rc != 0 and 'already exists' not in repo_add.stderr

- name: Update Helm repositories
  ansible.builtin.command:
    cmd: helm repo update
  changed_when: false

- name: Check if Headlamp release exists
  ansible.builtin.command:
    cmd: helm status {{ headlamp_release_name }} -n {{ headlamp_namespace }}
  register: helm_status
  failed_when: false
  changed_when: false

- name: Create temporary values file
  ansible.builtin.tempfile:
    state: file
    suffix: .yaml
  register: values_file

- name: Template Headlamp values
  ansible.builtin.template:
    src: values.yaml.j2
    dest: "{{ values_file.path }}"
    mode: "0644"

- name: Install Headlamp using Helm
  ansible.builtin.command:
    cmd: >
      helm install {{ headlamp_release_name }} {{ headlamp_helm_chart }}
      --version {{ headlamp_helm_chart_version }}
      --create-namespace
      --namespace {{ headlamp_namespace }}
      --values {{ values_file.path }}
      --timeout 10m
      --wait
  when: helm_status.rc != 0
  register: helm_install

- name: Upgrade Headlamp using Helm
  ansible.builtin.command:
    cmd: >
      helm upgrade {{ headlamp_release_name }} {{ headlamp_helm_chart }}
      --version {{ headlamp_helm_chart_version }}
      --namespace {{ headlamp_namespace }}
      --values {{ values_file.path }}
      --timeout 10m
      --wait
  when: helm_status.rc == 0
  register: helm_upgrade

- name: Wait for Headlamp pods to be ready
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    namespace: "{{ headlamp_namespace }}"
    label_selectors:
      - "app.kubernetes.io/name=headlamp"
  register: pod_info
  until: >
    pod_info.resources | length > 0 and
    pod_info.resources | selectattr('status.phase', 'equalto', 'Running') | list | length == (pod_info.resources | length)
  retries: 30
  delay: 10

- name: Create TLS Certificate for Headlamp
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'certificate.yaml.j2') | from_yaml }}"
  when: headlamp_ingress_enabled | default(true)

- name: Wait for TLS certificate to be ready
  kubernetes.core.k8s_info:
    api_version: cert-manager.io/v1
    kind: Certificate
    name: "{{ headlamp_tls_secret_name }}"
    namespace: "{{ headlamp_namespace }}"
  register: cert_info
  until: >
    cert_info.resources | length > 0 and
    cert_info.resources[0].status.conditions | default([]) | selectattr('type', 'equalto', 'Ready') | selectattr('status', 'equalto', 'True') | list | length > 0
  retries: 30
  delay: 10
  when: headlamp_ingress_enabled | default(true)

- name: Create Headlamp Ingress
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'ingress.yml.j2') | from_yaml }}"
  when: headlamp_ingress_enabled | default(true)

- name: Clean up temporary values file
  ansible.builtin.file:
    path: "{{ values_file.path }}"
    state: absent
  when: values_file.path is defined

- name: Display Headlamp access information
  ansible.builtin.debug:
    msg:
      - "Headlamp has been installed successfully using Helm!"
      - ""
      - "Installation details:"
      - "   - Namespace: {{ headlamp_namespace }}"
      - "   - Helm release: {{ headlamp_release_name }}"
      - "   - Pods ready: {{ pod_info.resources | selectattr('status.phase', 'equalto', 'Running') | list | length }}/{{ pod_info.resources | length }}"
      - ""
      - "Access methods:"
      - "   1. Ingress: https://{{ headlamp_ingress_host }}"
      - >-
        2. Port-forward: kubectl -n {{ headlamp_namespace }}
        port-forward svc/{{ headlamp_release_name }}
        {{ headlamp_local_port }}:{{ headlamp_service_port }}
      - "      Then access: http://localhost:{{ headlamp_local_port }}"
      - ""
      - "Usage:"
      - "   - Headlamp will use your cluster's RBAC permissions"
      - "   - No initial setup required - just log in with your credentials"
      - "   - Supports token-based authentication"
