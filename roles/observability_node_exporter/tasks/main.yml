---
- name: Deploy Node Exporter
  kubernetes.core.k8s:
    state: present
    definition: "{{ item }}"
  loop: "{{ lookup('template', 'node-exporter.yaml.j2') | from_yaml_all | list }}"

- name: Wait for Node Exporter DaemonSet to be ready
  ansible.builtin.command:
    cmd: kubectl rollout status daemonset/node-exporter -n {{ node_exporter_namespace }} --timeout=180s
  changed_when: false

- name: Display Node Exporter deployment status
  ansible.builtin.debug:
    msg:
      - "Node Exporter has been deployed successfully!"
      - ""
      - "Node Exporter is running as a DaemonSet on all cluster nodes"
      - "Metrics are available at: http://node-exporter.{{ node_exporter_namespace }}.svc.cluster.local:9100/metrics"
      - ""
      - "Prometheus will automatically discover and scrape these endpoints"
