---
- name: Add Kubernetes Dashboard Helm repository
  kubernetes.core.helm_repository:
    name: "{{ k8s_dashboard_helm_repo_name }}"
    repo_url: "{{ k8s_dashboard_helm_repo_url }}"

- name: Update Helm repositories
  ansible.builtin.command:
    cmd: helm repo update
  changed_when: true

- name: Deploy Kubernetes Dashboard using Helm
  kubernetes.core.helm:
    name: "{{ k8s_dashboard_release_name }}"
    chart_ref: "{{ k8s_dashboard_helm_chart }}"
    chart_version: "{{ k8s_dashboard_helm_chart_version }}"
    release_namespace: "{{ k8s_dashboard_namespace }}"
    create_namespace: true
  register: helm_result

- name: Wait for dashboard pods to be ready
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    namespace: "{{ k8s_dashboard_namespace }}"
    label_selectors:
      - "app.kubernetes.io/instance=kubernetes-dashboard"
  register: pod_info
  until: >
    pod_info.resources | length > 0 and
    pod_info.resources | selectattr('status.phase', 'equalto', 'Running') | list | length == (pod_info.resources | length)
  retries: 30
  delay: 10

- name: Create dashboard admin user
  kubernetes.core.k8s:
    state: present
    definition: "{{ item }}"
  loop: "{{ lookup('template', 'dashboard-admin.yml.j2') | from_yaml_all | list }}"

- name: Wait for admin token secret to be created
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Secret
    name: admin-user-token
    namespace: "{{ k8s_dashboard_namespace }}"
  register: admin_token
  until: admin_token.resources | length > 0
  retries: 12
  delay: 5

- name: Display dashboard access information
  ansible.builtin.debug:
    msg:
      - "ðŸŽ‰ Kubernetes Dashboard has been installed successfully using Helm!"
      - ""
      - "ðŸ“‹ Installation details:"
      - "   â€¢ Namespace: {{ k8s_dashboard_namespace }}"
      - "   â€¢ Helm release: {{ k8s_dashboard_release_name }}"
      - "   â€¢ Pods ready: {{ pod_info.resources | selectattr('status.phase', 'equalto', 'Running') | list | length }}/{{ pod_info.resources | length }}"
      - ""
      - "ðŸ”‘ Admin token: {{ admin_token.resources[0].data.token | b64decode }}"
      - ""
      - "ðŸŒ Access methods:"
      - >-
        1. Port-forward: kubectl -n {{ k8s_dashboard_namespace }}
        port-forward svc/{{ k8s_dashboard_release_name }}-kong-proxy
        {{ k8s_dashboard_local_port }}:{{ k8s_dashboard_service_port }}
      - "   2. Then access: https://localhost:{{ k8s_dashboard_local_port }}"
      - ""
      - "ðŸ“– Usage:"
      - "   â€¢ Use the admin token above to log in"
      - "   â€¢ Keep the port-forward running while using the dashboard"
