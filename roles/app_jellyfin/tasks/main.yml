---
- name: Create Jellyfin namespace
  include_role:
    name: common_k8s
    tasks_from: namespace
  vars:
    k8s_namespace: "{{ jellyfin_namespace }}"
    k8s_labels:
      app.kubernetes.io/name: jellyfin
      app.kubernetes.io/part-of: media

- name: Deploy NFS storage for media
  kubernetes.core.k8s:
    state: present
    definition: "{{ item }}"
  loop: "{{ lookup('template', 'storage.yaml.j2') | from_yaml_all | list }}"

- name: Create config PVC using common_k8s
  include_role:
    name: common_k8s
    tasks_from: storage
  vars:
    k8s_namespace: "{{ jellyfin_namespace }}"
    k8s_pvc_name: jellyfin-config-pvc
    k8s_pvc_size: "{{ jellyfin_config_storage }}"
    k8s_pvc_storage_class: "{{ jellyfin_storage_class }}"
    k8s_labels:
      app.kubernetes.io/name: jellyfin
      app.kubernetes.io/part-of: media

- name: Deploy Jellyfin application
  kubernetes.core.k8s:
    state: present
    definition: "{{ item }}"
  loop: "{{ lookup('template', 'jellyfin.yaml.j2') | from_yaml_all | list }}"

- name: Create TLS certificate using common_k8s
  include_role:
    name: common_k8s
    tasks_from: certificate
  vars:
    k8s_namespace: "{{ jellyfin_namespace }}"
    k8s_cert_name: "{{ jellyfin_tls_secret_name }}"
    k8s_cert_secret_name: "{{ jellyfin_tls_secret_name }}"
    k8s_cert_dns_names:
      - "{{ jellyfin_ingress_host }}"
    k8s_labels:
      app.kubernetes.io/name: jellyfin
      app.kubernetes.io/part-of: media
  when: jellyfin_ingress_enabled | default(true)

- name: Wait for TLS certificate to be ready
  kubernetes.core.k8s_info:
    api_version: cert-manager.io/v1
    kind: Certificate
    name: "{{ jellyfin_tls_secret_name }}"
    namespace: "{{ jellyfin_namespace }}"
  register: cert_info
  until: >
    cert_info.resources | length > 0 and
    cert_info.resources[0].status.conditions | default([]) | selectattr('type', 'equalto', 'Ready') | selectattr('status', 'equalto', 'True') | list | length > 0
  retries: 30
  delay: 10
  when: jellyfin_ingress_enabled | default(true)

- name: Create Ingress using common_k8s
  include_role:
    name: common_k8s
    tasks_from: ingress
  vars:
    k8s_namespace: "{{ jellyfin_namespace }}"
    k8s_ingress_name: jellyfin
    k8s_ingress_host: "{{ jellyfin_ingress_host }}"
    k8s_ingress_service_name: jellyfin
    k8s_ingress_service_port: 8096
    k8s_ingress_tls_secret: "{{ jellyfin_tls_secret_name }}"
    k8s_labels:
      app.kubernetes.io/name: jellyfin
      app.kubernetes.io/part-of: media
  when: jellyfin_ingress_enabled | default(true)

- name: Setup Cloudflare tunnel
  ansible.builtin.include_role:
    name: util_cloudflare_tunnel
  vars:
    cf_tunnel_name: "{{ jellyfin_cloudflare_tunnel_name }}"
    cf_tunnel_namespace: "{{ jellyfin_namespace }}"
    cf_tunnel_secret_name: "{{ jellyfin_cloudflare_tunnel_secret_name }}"
  when: jellyfin_cloudflare_tunnel_enabled | default(true)

- name: Deploy Cloudflare tunnel using common_k8s
  include_role:
    name: common_k8s
    tasks_from: cloudflare
  vars:
    k8s_namespace: "{{ jellyfin_namespace }}"
    k8s_cloudflare_tunnel_name: "{{ jellyfin_cloudflare_tunnel_name }}"
    k8s_cloudflare_external_hostname: "{{ jellyfin_external_url | regex_replace('^https?://', '') }}"
    k8s_cloudflare_internal_service: "http://jellyfin.{{ jellyfin_namespace }}.svc.cluster.local:8096"
    k8s_cloudflare_secret_name: "{{ jellyfin_cloudflare_tunnel_secret_name }}"
    k8s_labels:
      app.kubernetes.io/name: jellyfin
      app.kubernetes.io/part-of: media
  when: jellyfin_cloudflare_tunnel_enabled | default(true) and (cf_tunnel_configured | default(false))

- name: Wait for Jellyfin deployment to be ready
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: jellyfin
    namespace: "{{ jellyfin_namespace }}"
    wait: true
    wait_condition:
      type: Available
      status: "True"
    wait_timeout: 600

- name: Display deployment status
  ansible.builtin.debug:
    msg:
      - "Jellyfin has been deployed successfully!"
      - ""
      - "Internal access (corp network):"
      - "   Ingress: https://{{ jellyfin_ingress_host }}"
      - "   Service: http://jellyfin.{{ jellyfin_namespace }}.svc.cluster.local:8096"
      - ""
      - "External access (Cloudflare tunnel):"
      - "   URL: {{ jellyfin_external_url }}"
      - "   Tunnel: {{ jellyfin_cloudflare_tunnel_name }}"
      - "   Status: {{ 'Configured' if (cf_tunnel_configured | default(false)) else 'Manual setup required' }}"
      - ""
      - "Storage:"
      - "   Config: {{ jellyfin_storage_class }} ({{ jellyfin_config_storage }})"
      - "   Media: NFS at {{ jellyfin_nfs_path }} ({{ jellyfin_nfs_storage }})"
