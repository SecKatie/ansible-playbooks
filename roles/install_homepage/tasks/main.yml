---
- name: Create Homepage namespace
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'namespace.yaml.j2') | from_yaml }}"

- name: Create Homepage ConfigMap
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'configmap.yaml.j2') | from_yaml }}"
  register: homepage_configmap

- name: Create Homepage RBAC
  kubernetes.core.k8s:
    state: present
    definition: "{{ item }}"
  loop: "{{ lookup('template', 'rbac.yaml.j2') | from_yaml_all | list }}"

- name: Create Homepage Secrets
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'secret.yaml.j2') | from_yaml }}"
  register: homepage_secrets

- name: Create Homepage Storage (Icons and Images PVCs)
  kubernetes.core.k8s:
    state: present
    definition: "{{ item }}"
  loop: "{{ lookup('template', 'storage.yaml.j2') | from_yaml_all | list }}"
  when: homepage_icons_enabled | default(true)

- name: Create Homepage Deployment
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'deployment.yaml.j2') | from_yaml }}"
  register: homepage_deployment

- name: Create Homepage Service
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'service.yaml.j2') | from_yaml }}"

- name: Create TLS Certificate for Homepage
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'certificate.yaml.j2') | from_yaml }}"
  when: homepage_ingress_enabled | default(true)

- name: Wait for TLS certificate to be ready
  kubernetes.core.k8s_info:
    api_version: cert-manager.io/v1
    kind: Certificate
    name: "{{ homepage_tls_secret_name }}"
    namespace: "{{ homepage_namespace }}"
  register: cert_info
  until: >
    cert_info.resources | length > 0 and
    cert_info.resources[0].status.conditions | default([]) | selectattr('type', 'equalto', 'Ready') | selectattr('status', 'equalto', 'True') | list | length > 0
  retries: 30
  delay: 10
  when: homepage_ingress_enabled | default(true)

- name: Create Homepage Ingress
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'ingress.yaml.j2') | from_yaml }}"
  when: homepage_ingress_enabled | default(true)

- name: Restart Homepage Deployment when ConfigMap or Secrets change
  ansible.builtin.command:
    cmd: kubectl rollout restart deployment/homepage -n {{ homepage_namespace }}
  when: (homepage_configmap.changed or homepage_secrets.changed) and not homepage_deployment.changed

- name: Wait for Homepage Deployment to be ready
  ansible.builtin.command:
    cmd: kubectl rollout status deployment/homepage -n {{ homepage_namespace }} --timeout=600s
  changed_when: false

- name: Display Homepage access information
  ansible.builtin.debug:
    msg: |
      Homepage dashboard deployed successfully!

      Access via: https://{{ homepage_ingress_host }}

      To customize the dashboard, edit the ConfigMap:
        kubectl edit configmap homepage-config -n {{ homepage_namespace }}

      Then restart the pod:
        kubectl rollout restart deployment/homepage -n {{ homepage_namespace }}

      To add custom icons:
        ./scripts/homepage-add-icon.sh /path/to/icon.png
