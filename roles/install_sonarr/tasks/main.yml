---
- name: Create Sonarr namespace
  kubernetes.core.k8s:
    name: sonarr
    api_version: v1
    kind: Namespace
    state: present
    definition:
      metadata:
        labels:
          app.kubernetes.io/part-of: media
          app.kubernetes.io/managed-by: ansible
        annotations:
          app.kubernetes.io/description: "Sonarr PVR for TV shows with Mullvad VPN"

- name: Deploy Sonarr sealed secrets
  kubernetes.core.k8s:
    state: present
    src: "{{ role_path }}/files/sealedsecrets.yaml"

- name: Deploy Sonarr storage components
  kubernetes.core.k8s:
    state: present
    src: "{{ role_path }}/files/storage.yaml"

- name: Deploy Sonarr application
  kubernetes.core.k8s:
    state: present
    src: "{{ role_path }}/files/sonarr.yaml"

- name: Wait for Sonarr deployment to be ready
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: sonarr
    namespace: sonarr
    wait: true
    wait_condition:
      type: Available
      status: "True"
    wait_timeout: 600

- name: Get VPN public IP
  ansible.builtin.shell: |
    kubectl exec -n sonarr deployment/sonarr -c gluetun -- wget -qO- http://localhost:8000/v1/publicip/ip
  register: vpn_ip_result
  ignore_errors: true
  changed_when: false

- name: Display deployment status
  ansible.builtin.debug:
    msg:
      - "üéâ Sonarr has been deployed successfully!"
      - ""
      - "üîí VPN Status:"
      - "   ‚Ä¢ Provider: Mullvad WireGuard"
      - "   ‚Ä¢ VPN Public IP: {{ vpn_ip_result.stdout | default('Unable to retrieve - check pod logs') }}"
      - ""
      - "üì∫ Access Information:"
      - "   ‚Ä¢ Internal: http://sonarr.sonarr.svc.cluster.local:8989"
      - "   ‚Ä¢ Port Forward: kubectl -n sonarr port-forward svc/sonarr 8989:8989"
      - "   ‚Ä¢ Then access: http://localhost:8989"
      - ""
      - "üíæ Storage:"
      - "   ‚Ä¢ Config: Local storage (10Gi)"
      - "   ‚Ä¢ Media: NFS storage (shared with Jellyfin at /media)"
      - ""
      - "‚ö†Ô∏è  Important Notes:"
      - "   ‚Ä¢ All Sonarr traffic routes through Mullvad VPN via gluetun"
      - "   ‚Ä¢ Configure Sonarr to save downloads to /media/downloads"
      - "   ‚Ä¢ Configure Sonarr to save TV shows to /media/tv"
      - "   ‚Ä¢ Jellyfin can access these at /media/downloads and /media/tv"
      - ""
      - "üîß To update VPN credentials:"
      - "   1. Update roles/install_sonarr/files/secrets.yaml.example"
      - "   2. Seal it: kubeseal --format=yaml < /tmp/sonarr-vpn-secrets.yaml > roles/install_sonarr/files/sealedsecrets.yaml"
      - "   3. Re-run this playbook"
