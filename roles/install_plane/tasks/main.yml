---
- name: Add Plane Helm repository
  ansible.builtin.command:
    cmd: helm repo add {{ plane_helm_repo_name }} {{ plane_helm_repo_url }}
  register: repo_add
  changed_when: "'has been added' in repo_add.stdout"
  failed_when: repo_add.rc != 0 and 'already exists' not in repo_add.stderr

- name: Update Helm repositories
  ansible.builtin.command:
    cmd: helm repo update
  changed_when: true

- name: Create temp file for Helm values
  ansible.builtin.tempfile:
    state: file
    suffix: .yaml
  register: plane_values_tempfile

- name: Write Helm values to temp file
  ansible.builtin.template:
    src: values.yaml.j2
    dest: "{{ plane_values_tempfile.path }}"
    mode: '0600'

- name: Check if Plane release exists
  ansible.builtin.command:
    cmd: helm status {{ plane_release_name }} -n {{ plane_namespace }}
  register: helm_status
  failed_when: false
  changed_when: false

- name: Install Plane using Helm
  ansible.builtin.command:
    cmd: >
      helm install {{ plane_release_name }} {{ plane_helm_chart }}
      --create-namespace
      --namespace {{ plane_namespace }}
      -f {{ plane_values_tempfile.path }}
      --timeout 10m
      --wait
  when: helm_status.rc != 0
  register: helm_install

- name: Upgrade Plane using Helm
  ansible.builtin.command:
    cmd: >
      helm upgrade {{ plane_release_name }} {{ plane_helm_chart }}
      --namespace {{ plane_namespace }}
      -f {{ plane_values_tempfile.path }}
      --timeout 10m
      --wait
  when: helm_status.rc == 0
  register: helm_upgrade

- name: Clean up temp values file
  ansible.builtin.file:
    path: "{{ plane_values_tempfile.path }}"
    state: absent

- name: Create Traefik IngressRoute for Plane
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'ingress.yaml.j2') | from_yaml }}"
  when: plane_ingress_enabled

- name: Display Plane access information
  ansible.builtin.debug:
    msg:
      - "Plane has been deployed successfully!"
      - ""
      - "Installation details:"
      - "   - Namespace: {{ plane_namespace }}"
      - "   - Helm release: {{ plane_release_name }}"
      - "   - Version: {{ plane_version }}"
      - ""
      - "Access methods:"
      - "   1. Ingress: https://{{ plane_domain }}"
      - "   2. Port-forward: kubectl -n {{ plane_namespace }} port-forward svc/{{ plane_release_name }}-web {{ plane_local_port }}:3000"
      - "      Then access: http://localhost:{{ plane_local_port }}"
      - ""
      - "Initial setup:"
      - "   - Visit https://{{ plane_domain }}/god-mode to configure the instance"
      - "   - Create your first admin account"
      - "   - Configure SMTP settings for email notifications (optional)"
