---
- name: Add Portainer Helm repository
  ansible.builtin.command:
    cmd: helm repo add {{ portainer_helm_repo_name }} {{ portainer_helm_repo_url }}
  register: repo_add
  changed_when: "'has been added' in repo_add.stdout"
  failed_when: repo_add.rc != 0 and 'already exists' not in repo_add.stderr

- name: Update Helm repositories
  ansible.builtin.command:
    cmd: helm repo update
  changed_when: false

- name: Check if Portainer release exists
  ansible.builtin.command:
    cmd: helm status {{ portainer_release_name }} -n {{ portainer_namespace }}
  register: helm_status
  failed_when: false
  changed_when: false

- name: Create temporary values file
  ansible.builtin.tempfile:
    state: file
    suffix: .yaml
  register: values_file

- name: Template Portainer values
  ansible.builtin.template:
    src: values.yaml.j2
    dest: "{{ values_file.path }}"
    mode: "0644"

- name: Install Portainer using Helm
  ansible.builtin.command:
    cmd: >
      helm install {{ portainer_release_name }} {{ portainer_helm_chart }}
      --version {{ portainer_helm_chart_version }}
      --create-namespace
      --namespace {{ portainer_namespace }}
      --values {{ values_file.path }}
      --timeout 10m
      --wait
  when: helm_status.rc != 0
  register: helm_install

- name: Upgrade Portainer using Helm
  ansible.builtin.command:
    cmd: >
      helm upgrade {{ portainer_release_name }} {{ portainer_helm_chart }}
      --version {{ portainer_helm_chart_version }}
      --namespace {{ portainer_namespace }}
      --values {{ values_file.path }}
      --timeout 10m
      --wait
  when: helm_status.rc == 0
  register: helm_upgrade

- name: Wait for Portainer pods to be ready
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    namespace: "{{ portainer_namespace }}"
    label_selectors:
      - "app.kubernetes.io/name=portainer"
  register: pod_info
  until: >
    pod_info.resources | length > 0 and
    pod_info.resources | selectattr('status.phase', 'equalto', 'Running') | list | length == (pod_info.resources | length)
  retries: 30
  delay: 10

- name: Create Portainer ingress
  kubernetes.core.k8s:
    state: present
    definition: "{{ item }}"
  loop: "{{ lookup('template', 'ingress.yml.j2') | from_yaml_all | list }}"
  when: portainer_ingress_enabled | default(true)

- name: Clean up temporary values file
  ansible.builtin.file:
    path: "{{ values_file.path }}"
    state: absent
  when: values_file.path is defined

- name: Display Portainer access information
  ansible.builtin.debug:
    msg:
      - "Portainer has been installed successfully using Helm!"
      - ""
      - "Installation details:"
      - "   - Namespace: {{ portainer_namespace }}"
      - "   - Helm release: {{ portainer_release_name }}"
      - "   - Pods ready: {{ pod_info.resources | selectattr('status.phase', 'equalto', 'Running') | list | length }}/{{ pod_info.resources | length }}"
      - ""
      - "Access methods:"
      - "   1. Ingress: https://{{ portainer_ingress_host }}"
      - >-
        2. Port-forward: kubectl -n {{ portainer_namespace }}
        port-forward svc/{{ portainer_release_name }}
        {{ portainer_local_port }}:{{ portainer_service_port }}
      - "      Then access: https://localhost:{{ portainer_local_port }}"
      - ""
      - "Usage:"
      - "   - On first access, create an admin user and password"
      - "   - Portainer will automatically connect to your Kubernetes cluster"
      - "   - Default connection: Local Kubernetes cluster"
