---
# Example: Simple application role using common_k8s library
#
# This example shows how to deploy a simple application with:
# - Namespace
# - Storage (PVC)
# - Certificate (cert-manager)
# - Standard Ingress
#
# This replaces ~50 lines of templates with ~25 lines of task includes

- name: Deploy simple application using common_k8s
  hosts: localhost
  connection: local
  gather_facts: false
  
  vars:
    app_name: myapp
    app_namespace: myapp
    app_ingress_host: myapp.corp.mulliken.net
    app_storage_size: 10Gi
    
  tasks:
    # Create namespace
    - name: Create application namespace
      include_role:
        name: common_k8s
        tasks_from: namespace
      vars:
        k8s_namespace: "{{ app_namespace }}"
        k8s_labels:
          app.kubernetes.io/name: "{{ app_name }}"
          app.kubernetes.io/part-of: applications
    
    # Create storage
    - name: Create application storage
      include_role:
        name: common_k8s
        tasks_from: storage
      vars:
        k8s_namespace: "{{ app_namespace }}"
        k8s_pvc_name: "{{ app_name }}-data-pvc"
        k8s_pvc_size: "{{ app_storage_size }}"
        k8s_labels:
          app.kubernetes.io/name: "{{ app_name }}"
    
    # Create TLS certificate
    - name: Create TLS certificate
      include_role:
        name: common_k8s
        tasks_from: certificate
      vars:
        k8s_namespace: "{{ app_namespace }}"
        k8s_cert_name: "{{ app_name }}-tls"
        k8s_cert_secret_name: "{{ app_name }}-tls"
        k8s_cert_dns_names:
          - "{{ app_ingress_host }}"
        k8s_labels:
          app.kubernetes.io/name: "{{ app_name }}"
    
    # Deploy application (using your own template)
    - name: Deploy application
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('template', 'app.yaml.j2') }}"
    
    # Create Ingress
    - name: Create Ingress
      include_role:
        name: common_k8s
        tasks_from: ingress
      vars:
        k8s_namespace: "{{ app_namespace }}"
        k8s_ingress_name: "{{ app_name }}"
        k8s_ingress_host: "{{ app_ingress_host }}"
        k8s_ingress_service_name: "{{ app_name }}"
        k8s_ingress_service_port: 8080
        k8s_ingress_tls_secret: "{{ app_name }}-tls"
        k8s_labels:
          app.kubernetes.io/name: "{{ app_name }}"

