---
# Example: Application with both internal Ingress and external Cloudflare tunnel
#
# This example shows how to deploy an application with dual access:
# - Internal: Standard Ingress with cert-manager TLS
# - External: Cloudflare tunnel for public access

- name: Deploy application with dual access
  hosts: localhost
  connection: local
  gather_facts: false
  
  vars:
    app_name: jellyfin
    app_namespace: jellyfin
    app_ingress_host: jellyfin.corp.mulliken.net
    app_external_host: jellyfin.mulliken.net
    app_cloudflare_tunnel: jellyfin-tunnel
    
  tasks:
    # Create namespace
    - name: Create namespace
      include_role:
        name: common_k8s
        tasks_from: namespace
      vars:
        k8s_namespace: "{{ app_namespace }}"
        k8s_labels:
          app.kubernetes.io/name: "{{ app_name }}"
    
    # Internal access: Certificate + Ingress
    - name: Create internal TLS certificate
      include_role:
        name: common_k8s
        tasks_from: certificate
      vars:
        k8s_namespace: "{{ app_namespace }}"
        k8s_cert_name: "{{ app_name }}-tls"
        k8s_cert_secret_name: "{{ app_name }}-tls"
        k8s_cert_dns_names:
          - "{{ app_ingress_host }}"
    
    - name: Create internal Ingress
      include_role:
        name: common_k8s
        tasks_from: ingress
      vars:
        k8s_namespace: "{{ app_namespace }}"
        k8s_ingress_name: "{{ app_name }}"
        k8s_ingress_host: "{{ app_ingress_host }}"
        k8s_ingress_service_name: "{{ app_name }}"
        k8s_ingress_service_port: 8096
        k8s_ingress_tls_secret: "{{ app_name }}-tls"
    
    # External access: Cloudflare tunnel
    - name: Create Cloudflare tunnel
      include_role:
        name: common_k8s
        tasks_from: cloudflare
      vars:
        k8s_namespace: "{{ app_namespace }}"
        k8s_cloudflare_tunnel_name: "{{ app_cloudflare_tunnel }}"
        k8s_cloudflare_external_hostname: "{{ app_external_host }}"
        k8s_cloudflare_internal_service: "http://{{ app_name }}.{{ app_namespace }}.svc.cluster.local:8096"
        k8s_cloudflare_secret_name: cloudflare-tunnel-creds
        k8s_labels:
          app.kubernetes.io/name: "{{ app_name }}"

