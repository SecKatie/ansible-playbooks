---
# Create a Cloudflare tunnel deployment with ConfigMap
# Used for external access via Cloudflare tunnel
#
# Required variables:
#   - k8s_namespace: Namespace for cloudflared
#   - k8s_cloudflare_tunnel_name: Tunnel name
#   - k8s_cloudflare_external_hostname: External hostname (e.g., jellyfin.mulliken.net)
#   - k8s_cloudflare_internal_service: Internal service URL (e.g., http://jellyfin.jellyfin.svc.cluster.local:8096)
#   - k8s_cloudflare_secret_name: Name of the secret containing tunnel credentials
#
# Optional variables:
#   - k8s_cloudflare_deployment_name: Deployment name (default: cloudflared)
#   - k8s_cloudflare_replicas: Number of replicas (default: 1)
#   - k8s_cloudflare_image: Cloudflared image (default: cloudflare/cloudflared:2025.11.1)
#   - k8s_labels: Additional labels (dict)

- name: Validate required variables for cloudflare tunnel
  ansible.builtin.assert:
    that:
      - k8s_namespace is defined
      - k8s_namespace | length > 0
      - k8s_cloudflare_tunnel_name is defined
      - k8s_cloudflare_tunnel_name | length > 0
      - k8s_cloudflare_external_hostname is defined
      - k8s_cloudflare_external_hostname | length > 0
      - k8s_cloudflare_internal_service is defined
      - k8s_cloudflare_internal_service | length > 0
      - k8s_cloudflare_internal_service is match('^https?://')
      - k8s_cloudflare_secret_name is defined
      - k8s_cloudflare_secret_name | length > 0
      - k8s_cloudflare_deployment_name is not defined or k8s_cloudflare_deployment_name is string
      - k8s_cloudflare_replicas is not defined or k8s_cloudflare_replicas is number
      - k8s_cloudflare_replicas is not defined or k8s_cloudflare_replicas | int > 0
      - k8s_cloudflare_image is not defined or k8s_cloudflare_image is string
      - k8s_labels is not defined or k8s_labels is mapping
    fail_msg: |
      Variable validation failed for cloudflare tunnel:
      - k8s_namespace: {{ k8s_namespace | default('NOT DEFINED') }}
      - k8s_cloudflare_tunnel_name: {{ k8s_cloudflare_tunnel_name | default('NOT DEFINED') }}
      - k8s_cloudflare_external_hostname: {{ k8s_cloudflare_external_hostname | default('NOT DEFINED') }}
      - k8s_cloudflare_internal_service: {{ k8s_cloudflare_internal_service | default('NOT DEFINED') }}
      - k8s_cloudflare_secret_name: {{ k8s_cloudflare_secret_name | default('NOT DEFINED') }}
      
      Required: All variables above must be defined
      Note: k8s_cloudflare_internal_service must start with http:// or https://
      Optional: k8s_cloudflare_deployment_name, k8s_cloudflare_replicas (>0), k8s_cloudflare_image, k8s_labels
    success_msg: "Validation passed for cloudflare tunnel: {{ k8s_cloudflare_tunnel_name }}"

- name: Create Cloudflare tunnel ConfigMap
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: "{{ k8s_cloudflare_deployment_name | default('cloudflared') }}"
        namespace: "{{ k8s_namespace }}"
        labels: "{{ {'app.kubernetes.io/name': 'cloudflared', 'app.kubernetes.io/component': 'tunnel', 'app.kubernetes.io/managed-by': 'ansible'} | combine(k8s_labels | default({})) }}"
      data:
        config.yaml: |
          tunnel: {{ k8s_cloudflare_tunnel_name }}
          credentials-file: /etc/cloudflared/creds/credentials.json
          metrics: 0.0.0.0:2000
          no-autoupdate: true
          ingress:
          - hostname: {{ k8s_cloudflare_external_hostname }}
            service: {{ k8s_cloudflare_internal_service }}
          - service: http_status:404

- name: Create Cloudflare tunnel Deployment
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: "{{ k8s_cloudflare_deployment_name | default('cloudflared') }}"
        namespace: "{{ k8s_namespace }}"
        labels: "{{ {'app.kubernetes.io/name': 'cloudflared', 'app.kubernetes.io/component': 'tunnel', 'app.kubernetes.io/managed-by': 'ansible'} | combine(k8s_labels | default({})) }}"
      spec:
        selector:
          matchLabels:
            app.kubernetes.io/name: cloudflared
            app.kubernetes.io/instance: "{{ k8s_cloudflare_tunnel_name }}"
        replicas: "{{ k8s_cloudflare_replicas | default(1) }}"
        template:
          metadata:
            labels:
              app.kubernetes.io/name: cloudflared
              app.kubernetes.io/instance: "{{ k8s_cloudflare_tunnel_name }}"
              app.kubernetes.io/component: tunnel
              app.kubernetes.io/managed-by: ansible
          spec:
            affinity:
              nodeAffinity:
                preferredDuringSchedulingIgnoredDuringExecution:
                  - weight: 100
                    preference:
                      matchExpressions:
                        - key: node-role.kubernetes.io/control-plane
                          operator: DoesNotExist
            containers:
              - name: cloudflared
                image: "{{ k8s_cloudflare_image | default('cloudflare/cloudflared:2025.11.1') }}"
                imagePullPolicy: IfNotPresent
                args:
                  - tunnel
                  - --config
                  - /etc/cloudflared/config/config.yaml
                  - run
                livenessProbe:
                  httpGet:
                    path: /ready
                    port: 2000
                  failureThreshold: 3
                  initialDelaySeconds: 30
                  periodSeconds: 30
                  timeoutSeconds: 5
                readinessProbe:
                  httpGet:
                    path: /ready
                    port: 2000
                  failureThreshold: 3
                  initialDelaySeconds: 10
                  periodSeconds: 10
                  timeoutSeconds: 5
                resources:
                  requests:
                    cpu: "100m"
                    memory: "128Mi"
                  limits:
                    cpu: "200m"
                    memory: "256Mi"
                securityContext:
                  runAsUser: 1000
                  runAsNonRoot: true
                volumeMounts:
                  - name: config
                    mountPath: /etc/cloudflared/config
                    readOnly: true
                  - name: creds
                    mountPath: /etc/cloudflared/creds
                    readOnly: true
            volumes:
              - name: creds
                secret:
                  secretName: "{{ k8s_cloudflare_secret_name }}"
              - name: config
                configMap:
                  name: "{{ k8s_cloudflare_deployment_name | default('cloudflared') }}"
                  items:
                    - key: config.yaml
                      path: config.yaml

