---
# Create a cert-manager Certificate for Let's Encrypt TLS
#
# Required variables:
#   - k8s_namespace: Namespace for the certificate
#   - k8s_cert_name: Name of the Certificate resource
#   - k8s_cert_secret_name: Name of the TLS secret to create
#   - k8s_cert_dns_names: List of DNS names for the certificate
#
# Optional variables:
#   - k8s_cert_issuer: ClusterIssuer name (default: letsencrypt-prod)
#   - k8s_labels: Additional labels (dict)

- name: Validate required variables for certificate
  ansible.builtin.assert:
    that:
      - k8s_namespace is defined
      - k8s_namespace | length > 0
      - k8s_cert_name is defined
      - k8s_cert_name | length > 0
      - k8s_cert_secret_name is defined
      - k8s_cert_secret_name | length > 0
      - k8s_cert_dns_names is defined
      - k8s_cert_dns_names is sequence
      - k8s_cert_dns_names | length > 0
      - k8s_cert_issuer is not defined or k8s_cert_issuer is string
      - k8s_labels is not defined or k8s_labels is mapping
    fail_msg: |
      Variable validation failed for certificate creation:
      - k8s_namespace: {{ k8s_namespace | default('NOT DEFINED') }}
      - k8s_cert_name: {{ k8s_cert_name | default('NOT DEFINED') }}
      - k8s_cert_secret_name: {{ k8s_cert_secret_name | default('NOT DEFINED') }}
      - k8s_cert_dns_names: {{ k8s_cert_dns_names | default('NOT DEFINED') }}
      
      Required: k8s_namespace, k8s_cert_name, k8s_cert_secret_name, k8s_cert_dns_names (list)
      Optional: k8s_cert_issuer (string), k8s_labels (dictionary)
    success_msg: "Validation passed for certificate: {{ k8s_cert_name }}"

- name: Create cert-manager Certificate {{ k8s_cert_name }}
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: cert-manager.io/v1
      kind: Certificate
      metadata:
        name: "{{ k8s_cert_name }}"
        namespace: "{{ k8s_namespace }}"
        labels: "{{ {'app.kubernetes.io/managed-by': 'ansible'} | combine(k8s_labels | default({})) }}"
      spec:
        secretName: "{{ k8s_cert_secret_name }}"
        issuerRef:
          name: "{{ k8s_cert_issuer | default('letsencrypt-prod') }}"
          kind: ClusterIssuer
        dnsNames: "{{ k8s_cert_dns_names }}"

