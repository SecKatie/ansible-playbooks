---
# Create a Traefik IngressRoute with ServersTransport
# Used for HTTPS backends with self-signed certificates
#
# Required variables:
#   - k8s_namespace: Namespace for the IngressRoute
#   - k8s_ingressroute_name: Name of the IngressRoute resource
#   - k8s_ingressroute_host: Hostname for routing
#   - k8s_ingressroute_service_name: Backend service name
#   - k8s_ingressroute_service_port: Backend service port
#
# Optional variables:
#   - k8s_ingressroute_tls_secret: TLS secret name (default: wildcard-corp-tls)
#   - k8s_ingressroute_transport_name: ServersTransport name (auto-generated if not provided)
#   - k8s_ingressroute_insecure_skip_verify: Skip TLS verification (default: true)
#   - k8s_labels: Additional labels (dict)

- name: Validate required variables for ingressroute
  ansible.builtin.assert:
    that:
      - k8s_namespace is defined
      - k8s_namespace | length > 0
      - k8s_ingressroute_name is defined
      - k8s_ingressroute_name | length > 0
      - k8s_ingressroute_host is defined
      - k8s_ingressroute_host | length > 0
      - k8s_ingressroute_service_name is defined
      - k8s_ingressroute_service_name | length > 0
      - k8s_ingressroute_service_port is defined
      - k8s_ingressroute_service_port is number or k8s_ingressroute_service_port is string
      - k8s_ingressroute_tls_secret is not defined or k8s_ingressroute_tls_secret is string
      - k8s_ingressroute_transport_name is not defined or k8s_ingressroute_transport_name is string
      - k8s_ingressroute_insecure_skip_verify is not defined or k8s_ingressroute_insecure_skip_verify is boolean
      - k8s_labels is not defined or k8s_labels is mapping
    fail_msg: |
      Variable validation failed for ingressroute creation:
      - k8s_namespace: {{ k8s_namespace | default('NOT DEFINED') }}
      - k8s_ingressroute_name: {{ k8s_ingressroute_name | default('NOT DEFINED') }}
      - k8s_ingressroute_host: {{ k8s_ingressroute_host | default('NOT DEFINED') }}
      - k8s_ingressroute_service_name: {{ k8s_ingressroute_service_name | default('NOT DEFINED') }}
      - k8s_ingressroute_service_port: {{ k8s_ingressroute_service_port | default('NOT DEFINED') }}
      
      Required: All variables above must be defined
      Optional: k8s_ingressroute_tls_secret, k8s_ingressroute_transport_name, k8s_ingressroute_insecure_skip_verify (bool), k8s_labels
    success_msg: "Validation passed for ingressroute: {{ k8s_ingressroute_name }}"

- name: Create ServersTransport for {{ k8s_ingressroute_name }}
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: traefik.io/v1alpha1
      kind: ServersTransport
      metadata:
        name: "{{ k8s_ingressroute_transport_name | default(k8s_ingressroute_name + '-transport') }}"
        namespace: "{{ k8s_namespace }}"
        labels: "{{ {'app.kubernetes.io/managed-by': 'ansible'} | combine(k8s_labels | default({})) }}"
      spec:
        insecureSkipVerify: "{{ k8s_ingressroute_insecure_skip_verify | default(true) }}"

- name: Create IngressRoute {{ k8s_ingressroute_name }}
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: traefik.io/v1alpha1
      kind: IngressRoute
      metadata:
        name: "{{ k8s_ingressroute_name }}"
        namespace: "{{ k8s_namespace }}"
        labels: "{{ {'app.kubernetes.io/managed-by': 'ansible'} | combine(k8s_labels | default({})) }}"
      spec:
        entryPoints:
          - websecure
        routes:
          - match: "Host(`{{ k8s_ingressroute_host }}`)"
            kind: Rule
            services:
              - name: "{{ k8s_ingressroute_service_name }}"
                port: "{{ k8s_ingressroute_service_port }}"
                serversTransport: "{{ k8s_ingressroute_transport_name | default(k8s_ingressroute_name + '-transport') }}"
        tls:
          secretName: "{{ k8s_ingressroute_tls_secret | default('wildcard-corp-tls') }}"

