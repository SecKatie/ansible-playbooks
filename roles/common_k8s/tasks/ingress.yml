---
# Create a standard Kubernetes Ingress with TLS
#
# Required variables:
#   - k8s_namespace: Namespace for the ingress
#   - k8s_ingress_name: Name of the Ingress resource
#   - k8s_ingress_host: Hostname for the ingress
#   - k8s_ingress_service_name: Backend service name
#   - k8s_ingress_service_port: Backend service port
#   - k8s_ingress_tls_secret: TLS secret name
#
# Optional variables:
#   - k8s_ingress_class: Ingress class (default: traefik)
#   - k8s_ingress_path: Path for routing (default: /)
#   - k8s_ingress_path_type: Path type (default: Prefix)
#   - k8s_labels: Additional labels (dict)

- name: Validate required variables for ingress
  ansible.builtin.assert:
    that:
      - k8s_namespace is defined
      - k8s_namespace | length > 0
      - k8s_ingress_name is defined
      - k8s_ingress_name | length > 0
      - k8s_ingress_host is defined
      - k8s_ingress_host | length > 0
      - k8s_ingress_service_name is defined
      - k8s_ingress_service_name | length > 0
      - k8s_ingress_service_port is defined
      - k8s_ingress_service_port is number or k8s_ingress_service_port is string
      - k8s_ingress_tls_secret is defined
      - k8s_ingress_tls_secret | length > 0
      - k8s_ingress_class is not defined or k8s_ingress_class is string
      - k8s_ingress_path is not defined or k8s_ingress_path is string
      - k8s_ingress_path_type is not defined or k8s_ingress_path_type in ['Prefix', 'Exact', 'ImplementationSpecific']
      - k8s_labels is not defined or k8s_labels is mapping
    fail_msg: |
      Variable validation failed for ingress creation:
      - k8s_namespace: {{ k8s_namespace | default('NOT DEFINED') }}
      - k8s_ingress_name: {{ k8s_ingress_name | default('NOT DEFINED') }}
      - k8s_ingress_host: {{ k8s_ingress_host | default('NOT DEFINED') }}
      - k8s_ingress_service_name: {{ k8s_ingress_service_name | default('NOT DEFINED') }}
      - k8s_ingress_service_port: {{ k8s_ingress_service_port | default('NOT DEFINED') }}
      - k8s_ingress_tls_secret: {{ k8s_ingress_tls_secret | default('NOT DEFINED') }}
      
      Required: All variables above must be defined
      Optional: k8s_ingress_class, k8s_ingress_path, k8s_ingress_path_type (Prefix/Exact/ImplementationSpecific), k8s_labels
    success_msg: "Validation passed for ingress: {{ k8s_ingress_name }}"

- name: Create Ingress {{ k8s_ingress_name }}
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      metadata:
        name: "{{ k8s_ingress_name }}"
        namespace: "{{ k8s_namespace }}"
        labels: "{{ {'app.kubernetes.io/managed-by': 'ansible'} | combine(k8s_labels | default({})) }}"
      spec:
        ingressClassName: "{{ k8s_ingress_class | default('traefik') }}"
        tls:
          - hosts:
              - "{{ k8s_ingress_host }}"
            secretName: "{{ k8s_ingress_tls_secret }}"
        rules:
          - host: "{{ k8s_ingress_host }}"
            http:
              paths:
                - path: "{{ k8s_ingress_path | default('/') }}"
                  pathType: "{{ k8s_ingress_path_type | default('Prefix') }}"
                  backend:
                    service:
                      name: "{{ k8s_ingress_service_name }}"
                      port:
                        number: "{{ k8s_ingress_service_port }}"

