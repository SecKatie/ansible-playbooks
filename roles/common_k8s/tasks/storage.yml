---
# Create a PersistentVolumeClaim for application storage
#
# Required variables:
#   - k8s_namespace: Namespace for the PVC
#   - k8s_pvc_name: PVC name
#   - k8s_pvc_size: Storage size (e.g., 10Gi)
#
# Optional variables:
#   - k8s_pvc_storage_class: Storage class (default: longhorn)
#   - k8s_pvc_access_mode: Access mode (default: ReadWriteOnce)
#   - k8s_labels: Additional labels (dict)

- name: Validate required variables for storage
  ansible.builtin.assert:
    that:
      - k8s_namespace is defined
      - k8s_namespace | length > 0
      - k8s_pvc_name is defined
      - k8s_pvc_name | length > 0
      - k8s_pvc_size is defined
      - k8s_pvc_size is string
      - k8s_pvc_size is match('^\d+[KMGTP]i$')
      - k8s_pvc_storage_class is not defined or k8s_pvc_storage_class is string
      - k8s_pvc_access_mode is not defined or k8s_pvc_access_mode in ['ReadWriteOnce', 'ReadOnlyMany', 'ReadWriteMany', 'ReadWriteOncePod']
      - k8s_labels is not defined or k8s_labels is mapping
    fail_msg: |
      Variable validation failed for storage creation:
      - k8s_namespace: {{ k8s_namespace | default('NOT DEFINED') }}
      - k8s_pvc_name: {{ k8s_pvc_name | default('NOT DEFINED') }}
      - k8s_pvc_size: {{ k8s_pvc_size | default('NOT DEFINED') }}
      
      Required: All variables above must be defined
      Note: k8s_pvc_size must be in format: <number><Ki|Mi|Gi|Ti|Pi> (e.g., 10Gi)
      Optional: k8s_pvc_storage_class, k8s_pvc_access_mode (ReadWriteOnce/ReadOnlyMany/ReadWriteMany/ReadWriteOncePod), k8s_labels
    success_msg: "Validation passed for PVC: {{ k8s_pvc_name }}"

- name: Create PVC {{ k8s_pvc_name }}
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: PersistentVolumeClaim
      metadata:
        name: "{{ k8s_pvc_name }}"
        namespace: "{{ k8s_namespace }}"
        labels: "{{ {'app.kubernetes.io/component': 'storage', 'app.kubernetes.io/managed-by': 'ansible'} | combine(k8s_labels | default({})) }}"
      spec:
        accessModes:
          - "{{ k8s_pvc_access_mode | default('ReadWriteOnce') }}"
        resources:
          requests:
            storage: "{{ k8s_pvc_size }}"
        storageClassName: "{{ k8s_pvc_storage_class | default('longhorn') }}"

