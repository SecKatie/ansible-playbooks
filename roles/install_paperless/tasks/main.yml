---
- name: Create paperless namespace
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ paperless_namespace }}"
        labels:
          app.kubernetes.io/name: paperless
          app.kubernetes.io/managed-by: ansible

- name: Deploy Paperless secrets
  kubernetes.core.k8s:
    state: present
    definition: "{{ item }}"
  loop: "{{ lookup('template', 'secret.yaml.j2') | from_yaml_all | list }}"

- name: Render storage configuration
  ansible.builtin.template:
    src: "{{ role_path }}/templates/storage.yaml.j2"
    dest: "/tmp/paperless-storage.yaml"
    mode: '0644'

- name: Apply storage configuration
  kubernetes.core.k8s:
    state: present
    src: "/tmp/paperless-storage.yaml"

- name: Remove temporary storage file
  ansible.builtin.file:
    path: /tmp/paperless-storage.yaml
    state: absent

- name: Render Paperless-ngx deployment
  ansible.builtin.template:
    src: "{{ role_path }}/templates/paperless.yaml.j2"
    dest: "/tmp/paperless-deployment.yaml"
    mode: '0644'

- name: Apply Paperless-ngx deployment
  kubernetes.core.k8s:
    state: present
    src: "/tmp/paperless-deployment.yaml"

- name: Remove temporary deployment file
  ansible.builtin.file:
    path: /tmp/paperless-deployment.yaml
    state: absent

- name: Check if tunnel credentials are configured
  ansible.builtin.set_fact:
    tunnel_configured: "{{ paperless_tunnel_credentials is defined and paperless_tunnel_credentials | length > 0 }}"

- name: Apply Cloudflared tunnel configuration
  kubernetes.core.k8s:
    state: present
    src: "{{ role_path }}/files/cloudflared.yaml"
  when: tunnel_configured | default(false)

- name: Wait for PostgreSQL to be ready
  kubernetes.core.k8s_info:
    kind: Deployment
    namespace: "{{ paperless_namespace }}"
    name: paperless-postgres
  register: postgres_deployment
  until: postgres_deployment.resources[0].status.readyReplicas | default(0) >= 1
  retries: 30
  delay: 10

- name: Wait for Redis to be ready
  kubernetes.core.k8s_info:
    kind: Deployment
    namespace: "{{ paperless_namespace }}"
    name: paperless-redis
  register: redis_deployment
  until: redis_deployment.resources[0].status.readyReplicas | default(0) >= 1
  retries: 30
  delay: 10

- name: Wait for Paperless-ngx to be ready
  kubernetes.core.k8s_info:
    kind: Deployment
    namespace: "{{ paperless_namespace }}"
    name: paperless
  register: paperless_deployment
  until: paperless_deployment.resources[0].status.readyReplicas | default(0) >= 1
  retries: 60
  delay: 10

- name: Display access information
  ansible.builtin.debug:
    msg: |
      Paperless-ngx has been deployed successfully!

      {% if tunnel_configured | default(false) %}
      Access URL: https://{{ paperless_domain }}
      {% else %}
      Cloudflare tunnel not configured. For local access:
        kubectl -n {{ paperless_namespace }} port-forward svc/paperless 8000:8000
        Then visit: http://localhost:8000

      To set up the Cloudflare tunnel later:
        1. Create a tunnel: cloudflared tunnel create paperless-tunnel
        2. Add the tunnel credentials to playbooks/vars/paperless_secrets.yml
        3. Re-run this playbook
      {% endif %}

      Admin credentials:
      - Username: {{ paperless_admin_user }}
      - Password: {{ paperless_admin_password }}
