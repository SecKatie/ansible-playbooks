---
- name: Create paperless namespace
  ansible.builtin.include_role:
    name: common_k8s
    tasks_from: namespace
  vars:
    k8s_namespace: "{{ paperless_namespace }}"
    k8s_labels:
      app.kubernetes.io/name: paperless
      app.kubernetes.io/part-of: documents

- name: Deploy Paperless secrets
  kubernetes.core.k8s:
    state: present
    definition: "{{ item }}"
  loop: "{{ lookup('template', 'secret.yaml.j2') | from_yaml_all | list }}"

- name: Deploy NFS storage components
  kubernetes.core.k8s:
    state: present
    definition: "{{ item }}"
  loop: "{{ lookup('template', 'storage.yaml.j2') | from_yaml_all | list }}"

- name: Create application PVCs (Postgres/Redis/Proton Bridge)
  ansible.builtin.include_role:
    name: common_k8s
    tasks_from: storage
  loop:
    - name: paperless-postgres
      pvc: paperless-postgres-pvc
      size: "{{ paperless_postgres_size }}"
      component: database
      enabled: true
    - name: paperless-redis
      pvc: paperless-redis-pvc
      size: "{{ paperless_redis_size }}"
      component: cache
      enabled: true
    - name: proton-bridge
      pvc: proton-bridge-pvc
      size: "{{ paperless_proton_bridge_size | default('1Gi') }}"
      component: email
      enabled: "{{ paperless_email_enabled | default(false) | bool }}"
  loop_control:
    loop_var: pvc_item
  when: pvc_item.enabled | bool
  vars:
    k8s_namespace: "{{ paperless_namespace }}"
    k8s_pvc_name: "{{ pvc_item.pvc }}"
    k8s_pvc_size: "{{ pvc_item.size }}"
    k8s_pvc_storage_class: "{{ paperless_storage_class }}"
    k8s_labels:
      app.kubernetes.io/name: "{{ pvc_item.name }}"
      app.kubernetes.io/instance: paperless
      app.kubernetes.io/part-of: documents
      app.kubernetes.io/component: "{{ pvc_item.component }}"

- name: Deploy Paperless-ngx resources
  kubernetes.core.k8s:
    state: present
    definition: "{{ item }}"
  loop: "{{ lookup('template', 'paperless.yaml.j2') | from_yaml_all | list }}"

- name: Setup Cloudflare tunnel
  ansible.builtin.include_role:
    name: util_cloudflare_tunnel
  vars:
    cf_tunnel_name: "{{ paperless_cloudflare_tunnel_name }}"
    cf_tunnel_namespace: "{{ paperless_namespace }}"
    cf_tunnel_secret_name: "{{ paperless_cloudflare_tunnel_secret_name }}"
  when: paperless_cloudflare_enabled | default(true)

- name: Deploy Cloudflare tunnel
  ansible.builtin.include_role:
    name: common_k8s
    tasks_from: cloudflare
  vars:
    k8s_namespace: "{{ paperless_namespace }}"
    k8s_cloudflare_tunnel_name: "{{ cf_tunnel_id | default(paperless_cloudflare_tunnel_name) }}"
    k8s_cloudflare_external_hostname: "{{ paperless_domain }}"
    k8s_cloudflare_internal_service: "http://paperless.{{ paperless_namespace }}.svc.cluster.local:8000"
    k8s_cloudflare_secret_name: "{{ paperless_cloudflare_tunnel_secret_name }}"
    k8s_labels:
      app.kubernetes.io/name: paperless
      app.kubernetes.io/part-of: documents
  when: paperless_cloudflare_enabled | default(true) and (cf_tunnel_configured | default(false))

- name: Wait for PostgreSQL to be ready
  kubernetes.core.k8s_info:
    kind: Deployment
    namespace: "{{ paperless_namespace }}"
    name: paperless-postgres
  register: postgres_deployment
  until: postgres_deployment.resources[0].status.readyReplicas | default(0) >= 1
  retries: 30
  delay: 10

- name: Wait for Redis to be ready
  kubernetes.core.k8s_info:
    kind: Deployment
    namespace: "{{ paperless_namespace }}"
    name: paperless-redis
  register: redis_deployment
  until: redis_deployment.resources[0].status.readyReplicas | default(0) >= 1
  retries: 30
  delay: 10

- name: Wait for Paperless-ngx to be ready
  kubernetes.core.k8s_info:
    kind: Deployment
    namespace: "{{ paperless_namespace }}"
    name: paperless
  register: paperless_deployment
  until: paperless_deployment.resources[0].status.readyReplicas | default(0) >= 1
  retries: 60
  delay: 10

- name: Display access information
  ansible.builtin.debug:
    msg: |
      Paperless-ngx has been deployed successfully!

      {% if cf_tunnel_configured | default(false) %}
      Access URL: https://{{ paperless_domain }}
      {% else %}
      Cloudflare tunnel not configured. For local access:
        kubectl -n {{ paperless_namespace }} port-forward svc/paperless 8000:8000
        Then visit: http://localhost:8000

      To set up the Cloudflare tunnel later:
        1. Create a tunnel: cloudflared tunnel create paperless-tunnel
        2. Add the tunnel credentials to playbooks/vars/paperless_secrets.yml
        3. Re-run this playbook
      {% endif %}

      Admin credentials:
      - Username: {{ paperless_admin_user }}
      - Password: {{ paperless_admin_password }}
