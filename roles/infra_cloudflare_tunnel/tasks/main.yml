---
# Shared Cloudflare Tunnel Setup
# Required variables:
#   - cf_tunnel_name: Name of the tunnel (e.g., "jellyfin-tunnel")
#   - cf_tunnel_namespace: Kubernetes namespace for the secret
#   - cf_tunnel_secret_name: Name of the Kubernetes secret

- name: Validate required variables
  ansible.builtin.assert:
    that:
      - cf_tunnel_name is defined
      - cf_tunnel_namespace is defined
      - cf_tunnel_secret_name is defined
    fail_msg: "Required variables cf_tunnel_name, cf_tunnel_namespace, and cf_tunnel_secret_name must be defined"
  when: cf_tunnel_enabled | default(true)

- name: Check if Cloudflare tunnel already exists
  ansible.builtin.shell: |
    cloudflared tunnel list --output json
  register: cf_tunnel_list_result
  failed_when: false
  changed_when: false
  when: cf_tunnel_enabled | default(true)

- name: Initialize existing_tunnel variable
  ansible.builtin.set_fact:
    cf_existing_tunnel: {}
  when:
    - cf_tunnel_enabled | default(true)
    - cf_tunnel_list_result.rc != 0 or cf_tunnel_list_result.stdout == ""

- name: Extract existing tunnel information
  ansible.builtin.set_fact:
    cf_existing_tunnel: "{{ (cf_tunnel_list_result.stdout | from_json) | selectattr('name', 'equalto', cf_tunnel_name) | list | first | default({}) }}"
  when:
    - cf_tunnel_enabled | default(true)
    - cf_tunnel_list_result.rc == 0
    - cf_tunnel_list_result.stdout != ""

- name: Create Cloudflare tunnel if it doesn't exist
  ansible.builtin.shell: |
    cloudflared tunnel create {{ cf_tunnel_name }}
  register: cf_tunnel_create_result
  failed_when: false
  when:
    - cf_tunnel_enabled | default(true)
    - cf_existing_tunnel == {}

- name: Set tunnel information from existing tunnel
  ansible.builtin.set_fact:
    cf_tunnel_id: "{{ cf_existing_tunnel.id }}"
    cf_tunnel_creds_path: "{{ lookup('env', 'HOME') }}/.cloudflared/{{ cf_existing_tunnel.id }}.json"
    cf_tunnel_status: "existing"
  when:
    - cf_tunnel_enabled | default(true)
    - cf_existing_tunnel != {}

- name: Set tunnel information from newly created tunnel
  ansible.builtin.set_fact:
    cf_tunnel_id: "{{ cf_tunnel_create_result.stdout | regex_search('([a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12})', '\\1') | first }}"
    cf_tunnel_creds_path: "{{ cf_tunnel_create_result.stdout | regex_search('(/.*?\\.json)', '\\1') | first }}"
    cf_tunnel_status: "created"
  when:
    - cf_tunnel_enabled | default(true)
    - cf_tunnel_create_result is defined
    - cf_tunnel_create_result is not skipped
    - cf_tunnel_create_result.rc == 0

- name: Check if tunnel credentials secret exists
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Secret
    name: "{{ cf_tunnel_secret_name }}"
    namespace: "{{ cf_tunnel_namespace }}"
  register: cf_secret_check
  when:
    - cf_tunnel_enabled | default(true)
    - cf_tunnel_id is defined
    - cf_tunnel_creds_path is defined

- name: Create or update tunnel credentials secret
  ansible.builtin.shell: |
    kubectl create secret generic {{ cf_tunnel_secret_name }} \
      --from-file=credentials.json="{{ cf_tunnel_creds_path }}" \
      --namespace={{ cf_tunnel_namespace }} \
      --dry-run=client -o yaml | kubectl apply -f -
  register: cf_secret_result
  when:
    - cf_tunnel_enabled | default(true)
    - cf_tunnel_id is defined
    - cf_tunnel_creds_path is defined
    - cf_secret_check.resources | length == 0
  changed_when: true

- name: Set tunnel setup status
  ansible.builtin.set_fact:
    cf_tunnel_configured: "{{ cf_tunnel_id is defined }}"
  when: cf_tunnel_enabled | default(true)
