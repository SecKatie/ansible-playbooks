---
# Apply manifests in correct dependency order:
# 1. Namespace first (required by all other resources)
# 2. Storage (PVC required by deployment)
# 3. ConfigMap (required by deployment)
# 4. Prometheus deployment/service/RBAC
# 5. kube-state-metrics (provides K8s cluster metrics)
# 6. Ingress (optional external access)

- name: Create Prometheus namespace
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'namespace.yaml.j2') | from_yaml }}"

- name: Deploy Prometheus storage
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'storage.yaml.j2') | from_yaml }}"

- name: Deploy Prometheus ConfigMap
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'configmap.yaml.j2') | from_yaml }}"

- name: Deploy Prometheus application
  kubernetes.core.k8s:
    state: present
    definition: "{{ item }}"
  loop: "{{ lookup('template', 'prometheus.yaml.j2') | from_yaml_all | list }}"

- name: Deploy kube-state-metrics
  kubernetes.core.k8s:
    state: present
    definition: "{{ item }}"
  loop: "{{ lookup('template', 'kube-state-metrics.yaml.j2') | from_yaml_all | list }}"

- name: Create TLS Certificate for Prometheus
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'certificate.yaml.j2') | from_yaml }}"
  when: prometheus_ingress_enabled | default(true)

- name: Wait for TLS certificate to be ready
  kubernetes.core.k8s_info:
    api_version: cert-manager.io/v1
    kind: Certificate
    name: "{{ prometheus_tls_secret_name }}"
    namespace: "{{ prometheus_namespace }}"
  register: cert_info
  until: >
    cert_info.resources | length > 0 and
    cert_info.resources[0].status.conditions | default([]) | selectattr('type', 'equalto', 'Ready') | selectattr('status', 'equalto', 'True') | list | length > 0
  retries: 30
  delay: 10
  when: prometheus_ingress_enabled | default(true)

- name: Deploy Prometheus Ingress
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'ingress.yaml.j2') | from_yaml }}"
  when: prometheus_ingress_enabled | default(true)

- name: Wait for Prometheus deployment to be ready
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: prometheus
    namespace: "{{ prometheus_namespace }}"
    wait: true
    wait_condition:
      type: Available
      status: "True"
    wait_timeout: 300

- name: Wait for kube-state-metrics deployment to be ready
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: kube-state-metrics
    namespace: "{{ prometheus_namespace }}"
    wait: true
    wait_condition:
      type: Available
      status: "True"
    wait_timeout: 120

- name: Display Prometheus deployment status
  ansible.builtin.debug:
    msg:
      - "Prometheus and kube-state-metrics have been deployed successfully!"
      - ""
      - "Access Prometheus:"
      - "  Ingress: https://{{ prometheus_ingress_host }}"
      - "  Port-forward: kubectl -n {{ prometheus_namespace }} port-forward svc/prometheus 9090:9090"
      - ""
      - "Internal cluster access: http://prometheus.{{ prometheus_namespace }}.svc.cluster.local:9090"
      - ""
      - "kube-state-metrics provides Kubernetes object metrics (pods, deployments, etc.)"
