---
- name: Create Agate namespace
  kubernetes.core.k8s:
    name: "{{ agate_namespace }}"
    api_version: v1
    kind: Namespace
    state: present
    definition:
      metadata:
        labels:
          app.kubernetes.io/name: agate
          app.kubernetes.io/managed-by: ansible
        annotations:
          app.kubernetes.io/description: "Agate Gemini server namespace"

- name: Deploy Agate storage components
  kubernetes.core.k8s:
    state: present
    definition: "{{ item }}"
  loop: "{{ lookup('template', 'storage.yaml.j2') | from_yaml_all | list }}"

- name: Deploy Agate application
  kubernetes.core.k8s:
    state: present
    definition: "{{ item }}"
  loop: "{{ lookup('template', 'agate.yaml.j2') | from_yaml_all | list }}"

- name: Wait for Agate deployment to be ready
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: agate
    namespace: "{{ agate_namespace }}"
    wait: true
    wait_condition:
      type: Available
      status: "True"
    wait_timeout: 300

- name: Get Agate service details
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Service
    name: agate
    namespace: "{{ agate_namespace }}"
  register: agate_service

- name: Display deployment status
  ansible.builtin.debug:
    msg:
      - "Agate Gemini server has been deployed successfully!"
      - ""
      - "Gemini Access:"
      - "   Protocol: gemini://"
      - "   Hostname: {{ agate_hostname }}"
      - "   Port: {{ agate_port }}"
      - "   URL: gemini://{{ agate_hostname }}/"
      - ""
      - "Service Type: {{ agate_service_type }}"
      - "{% if agate_service_type == 'LoadBalancer' and agate_service.resources[0].status.loadBalancer.ingress | default([]) | length > 0 %}   External IP: {{ agate_service.resources[0].status.loadBalancer.ingress[0].ip | default(agate_service.resources[0].status.loadBalancer.ingress[0].hostname) }}{% endif %}"
      - ""
      - "Storage:"
      - "   Content: {{ agate_storage_class }} ({{ agate_content_storage }})"
      - "   Certificates: {{ agate_storage_class }} ({{ agate_certs_storage }})"
      - "{% if agate_nfs_enabled %}   NFS Content: {{ agate_nfs_server }}:{{ agate_nfs_path }}{% endif %}"
      - ""
      - "Content Directory: /gmi (mount point for Gemini content)"
      - "   - Place .gmi files in the content PVC"
      - "   - Create index.gmi for directory root pages"
      - ""
      - "NOTE: Agate auto-generates TLS certificates on first start."
      - "      Certificates are stored in the certs PVC for persistence."
