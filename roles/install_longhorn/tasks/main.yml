---
- name: Create Longhorn namespace
  kubernetes.core.k8s:
    name: "{{ longhorn_namespace }}"
    api_version: v1
    kind: Namespace
    state: present

- name: Apply Longhorn manifests
  kubernetes.core.k8s:
    state: present
    src: "https://raw.githubusercontent.com/longhorn/longhorn/v{{ longhorn_version }}/deploy/longhorn.yaml"
    apply: true
    server_side_apply:
      field_manager: ansible
      force_conflicts: true

- name: Wait for Longhorn manager pods to be ready
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    namespace: "{{ longhorn_namespace }}"
    label_selectors:
      - app=longhorn-manager
    field_selectors:
      - status.phase=Running
  register: longhorn_pods
  until: longhorn_pods.resources | length >= 3
  retries: 30
  delay: 10

- name: Wait for Longhorn admission webhook to be ready
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Endpoints
    namespace: "{{ longhorn_namespace }}"
    name: longhorn-admission-webhook
  register: webhook_endpoints
  until: >-
    webhook_endpoints.resources | length > 0 and
    webhook_endpoints.resources[0].subsets | default([]) | length > 0
  retries: 30
  delay: 10

- name: Disable upgrade checker
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: longhorn.io/v1beta2
      kind: Setting
      metadata:
        name: upgrade-checker
        namespace: "{{ longhorn_namespace }}"
      value: "{{ longhorn_upgrade_checker | string | lower }}"
  when: not longhorn_upgrade_checker
  retries: 5
  delay: 10
  register: upgrade_checker_result
  until: upgrade_checker_result is succeeded

- name: Display Longhorn status
  ansible.builtin.debug:
    msg:
      - "Longhorn v{{ longhorn_version }} has been deployed!"
      - ""
      - "Access the Longhorn UI:"
      - "  kubectl -n longhorn-system port-forward svc/longhorn-frontend 8080:80"
      - "  http://localhost:8080"
      - ""
      - "Registered nodes:"
      - "  kubectl get nodes.longhorn.io -n longhorn-system"
