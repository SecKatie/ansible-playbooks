---
- name: Download cert-manager manifest
  ansible.builtin.get_url:
    url: "{{ install_cert_manager_manifest_url }}"
    dest: "{{ install_cert_manager_manifest_dest }}"
    mode: '0644'
  register: install_cert_manager_download_result
  until: install_cert_manager_download_result is succeeded
  retries: 3
  delay: 5
  changed_when: install_cert_manager_download_result.changed

- name: Deploy cert-manager
  kubernetes.core.k8s:
    state: present
    src: "{{ install_cert_manager_manifest_dest }}"
  register: install_cert_manager_deploy_result
  changed_when: install_cert_manager_deploy_result.changed

- name: Wait for cert-manager namespace to be created
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Namespace
    name: "{{ install_cert_manager_namespace }}"
  register: install_cert_manager_namespace_info
  until: install_cert_manager_namespace_info.resources | length > 0
  retries: 30
  delay: 5

- name: Wait for cert-manager pods to be ready
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    namespace: "{{ install_cert_manager_namespace }}"
    label_selectors:
      - "app.kubernetes.io/instance=cert-manager"
  register: install_cert_manager_pod_info
  until: >
    install_cert_manager_pod_info.resources | length >= 3 and
    install_cert_manager_pod_info.resources | selectattr('status.phase', 'equalto', 'Running') | list | length ==
    (install_cert_manager_pod_info.resources | length)
  retries: "{{ (install_cert_manager_wait_timeout / 10) | int }}"
  delay: 10

- name: Check if cmctl is available
  ansible.builtin.command: which cmctl
  register: install_cert_manager_cmctl_check
  failed_when: false
  changed_when: false
  when: install_cert_manager_verify_installation

- name: Verify cert-manager API is ready (using cmctl)
  ansible.builtin.command: cmctl check api --wait=2m
  register: install_cert_manager_api_check
  when:
    - install_cert_manager_verify_installation
    - install_cert_manager_cmctl_check.rc == 0
  changed_when: false

- name: Verify cert-manager API is ready (manual check)
  kubernetes.core.k8s_info:
    api_version: cert-manager.io/v1
    kind: ClusterIssuer
  register: install_cert_manager_crd_check
  when:
    - install_cert_manager_verify_installation
    - install_cert_manager_cmctl_check.rc != 0
  changed_when: false

- name: Create end-to-end test resources
  kubernetes.core.k8s:
    state: present
    definition:
      - apiVersion: v1
        kind: Namespace
        metadata:
          name: cert-manager-test
      - apiVersion: cert-manager.io/v1
        kind: Issuer
        metadata:
          name: test-selfsigned
          namespace: cert-manager-test
        spec:
          selfSigned: {}
      - apiVersion: cert-manager.io/v1
        kind: Certificate
        metadata:
          name: selfsigned-cert
          namespace: cert-manager-test
        spec:
          dnsNames:
            - example.com
          secretName: selfsigned-cert-tls
          issuerRef:
            name: test-selfsigned
  when: install_cert_manager_e2e_test

- name: Wait for test certificate to be ready
  kubernetes.core.k8s_info:
    api_version: cert-manager.io/v1
    kind: Certificate
    name: selfsigned-cert
    namespace: cert-manager-test
    wait: true
    wait_condition:
      type: Ready
      status: "True"
    wait_timeout: 60
  when: install_cert_manager_e2e_test

- name: Clean up test resources
  kubernetes.core.k8s:
    state: absent
    api_version: v1
    kind: Namespace
    name: cert-manager-test
  when: install_cert_manager_e2e_test

- name: Display cert-manager installation status
  ansible.builtin.debug:
    msg:
      - "ðŸŽ‰ cert-manager has been installed successfully!"
      - ""
      - "ðŸ“‹ Installation details:"
      - "   â€¢ Version: {{ install_cert_manager_version }}"
      - "   â€¢ Namespace: {{ install_cert_manager_namespace }}"
      - "   â€¢ Components: cert-manager, cert-manager-cainjector, cert-manager-webhook"
      - ""
      - "âœ… Verification status:"
      - >-
        â€¢ Pods ready: {{
        install_cert_manager_pod_info.resources | selectattr('status.phase', 'equalto', 'Running') | list | length
        }}/{{ install_cert_manager_pod_info.resources | length }}
      - >-
        â€¢ API ready: {{
        'Yes' if (install_cert_manager_api_check is defined and
        install_cert_manager_api_check.rc is defined and
        install_cert_manager_api_check.rc == 0) or
        (install_cert_manager_crd_check is defined and
        install_cert_manager_crd_check.resources is defined)
        else 'Check manually with: cmctl check api' }}
      - "   â€¢ E2E test: {{ 'Passed' if install_cert_manager_e2e_test else 'Skipped' }}"
      - ""
      - "ðŸ“– Next steps:"
      - "   1. Create issuers (ClusterIssuer or Issuer resources)"
      - "   2. Request certificates using Certificate resources"
      - "   3. See https://cert-manager.io/docs/configuration/ for configuration options"
      - ""
      - "ðŸ”§ Useful commands:"
      - "   â€¢ Check status: kubectl get pods -n {{ install_cert_manager_namespace }}"
      - "   â€¢ Verify API: cmctl check api"
      - "   â€¢ View logs: kubectl logs -n {{ install_cert_manager_namespace }} deployment/cert-manager"
