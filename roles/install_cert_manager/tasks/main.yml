---
- name: Check if cert-manager release exists
  ansible.builtin.command:
    cmd: helm status {{ cert_manager_release_name }} -n {{ cert_manager_namespace }}
  register: helm_status
  failed_when: false
  changed_when: false

- name: Install cert-manager using Helm OCI
  ansible.builtin.command:
    cmd: >
      helm install {{ cert_manager_release_name }} {{ cert_manager_helm_chart }}
      --version {{ cert_manager_helm_version }}
      --namespace {{ cert_manager_namespace }}
      --create-namespace
      --set crds.enabled=true
      --set 'dns01RecursiveNameservers=1.1.1.1:53\,8.8.8.8:53'
      --set dns01RecursiveNameserversOnly=true
      --wait
      --timeout 5m
  when: helm_status.rc != 0
  register: helm_install

- name: Upgrade cert-manager using Helm OCI
  ansible.builtin.command:
    cmd: >
      helm upgrade {{ cert_manager_release_name }} {{ cert_manager_helm_chart }}
      --version {{ cert_manager_helm_version }}
      --namespace {{ cert_manager_namespace }}
      --set crds.enabled=true
      --set 'dns01RecursiveNameservers=1.1.1.1:53\,8.8.8.8:53'
      --set dns01RecursiveNameserversOnly=true
      --wait
      --timeout 5m
  when: helm_status.rc == 0
  register: helm_upgrade

- name: Wait for cert-manager pods to be ready
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    namespace: "{{ cert_manager_namespace }}"
    label_selectors:
      - "app.kubernetes.io/instance=cert-manager"
  register: pod_info
  until: >
    pod_info.resources | length > 0 and
    pod_info.resources | selectattr('status.phase', 'equalto', 'Running') | list | length == (pod_info.resources | length)
  retries: 30
  delay: 10

- name: Get Cloudflare API token from kube-system
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Secret
    name: "{{ cert_manager_cloudflare_api_token_secret_name }}"
    namespace: kube-system
  register: cloudflare_secret

- name: Copy Cloudflare API token to cert-manager namespace
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: "{{ cert_manager_cloudflare_api_token_secret_name }}"
        namespace: "{{ cert_manager_namespace }}"
      type: Opaque
      data: "{{ cloudflare_secret.resources[0].data }}"
  when: cloudflare_secret.resources | length > 0

- name: Create ClusterIssuer for Let's Encrypt with Cloudflare DNS
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'clusterissuer.yaml.j2') | from_yaml }}"

- name: Wait for ClusterIssuer to be ready
  kubernetes.core.k8s_info:
    api_version: cert-manager.io/v1
    kind: ClusterIssuer
    name: letsencrypt-prod
  register: issuer_status
  until: >
    issuer_status.resources | length > 0 and
    (issuer_status.resources[0].status.conditions | default([]) | selectattr('type', 'equalto', 'Ready') | selectattr('status', 'equalto', 'True') | list | length > 0)
  retries: 12
  delay: 10

- name: Display cert-manager information
  ansible.builtin.debug:
    msg:
      - "cert-manager has been installed successfully!"
      - ""
      - "Installation details:"
      - "  - Namespace: {{ cert_manager_namespace }}"
      - "  - Helm release: {{ cert_manager_release_name }}"
      - "  - Version: {{ cert_manager_helm_version }}"
      - ""
      - "ClusterIssuer: letsencrypt-prod"
      - "  - ACME server: {{ cert_manager_acme_server }}"
      - "  - DNS solver: Cloudflare"
      - ""
      - "To create a certificate:"
      - "  apiVersion: cert-manager.io/v1"
      - "  kind: Certificate"
      - "  metadata:"
      - "    name: my-cert"
      - "    namespace: my-namespace"
      - "  spec:"
      - "    secretName: my-cert-tls"
      - "    issuerRef:"
      - "      name: letsencrypt-prod"
      - "      kind: ClusterIssuer"
      - "    dnsNames:"
      - "      - example.com"
