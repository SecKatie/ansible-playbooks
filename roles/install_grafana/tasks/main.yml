---
- name: Check if Grafana sealed secret is configured
  ansible.builtin.shell: |
    grep -q "kind: SealedSecret" "{{ role_path }}/files/sealedsecrets.yaml"
  register: sealed_secret_check
  failed_when: false
  changed_when: false

- name: Fail if sealed secret is not configured
  ansible.builtin.fail:
    msg:
      - "ERROR: Grafana admin credentials sealed secret is not configured!"
      - ""
      - "Please create the sealed secret before deploying Grafana:"
      - "  1. cp {{ role_path }}/files/secrets.yaml.example /tmp/grafana-secrets.yaml"
      - "  2. Edit /tmp/grafana-secrets.yaml with your admin credentials"
      - "  3. kubeseal --format=yaml < /tmp/grafana-secrets.yaml > {{ role_path }}/files/sealedsecrets.yaml"
      - "  4. rm /tmp/grafana-secrets.yaml"
      - "  5. Re-run this playbook"
  when: sealed_secret_check.rc != 0

- name: Create Grafana namespace
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'namespace.yaml.j2') | from_yaml }}"

- name: Deploy Grafana storage
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'storage.yaml.j2') | from_yaml }}"

- name: Deploy Grafana ConfigMaps
  kubernetes.core.k8s:
    state: present
    definition: "{{ item }}"
  loop: "{{ lookup('template', 'configmap.yaml.j2') | from_yaml_all | list }}"

- name: Deploy Grafana sealed secrets
  kubernetes.core.k8s:
    state: present
    src: "{{ role_path }}/files/sealedsecrets.yaml"

- name: Deploy Grafana application
  kubernetes.core.k8s:
    state: present
    definition: "{{ item }}"
  loop: "{{ lookup('template', 'grafana.yaml.j2') | from_yaml_all | list }}"

- name: Deploy Grafana ingress
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'ingress.yaml.j2') | from_yaml }}"
  when: grafana_ingress_enabled | default(true)

- name: Wait for Grafana deployment to be ready
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: grafana
    namespace: "{{ grafana_namespace }}"
    wait: true
    wait_condition:
      type: Available
      status: "True"
    wait_timeout: 300

- name: Display Grafana deployment status
  ansible.builtin.debug:
    msg:
      - "Grafana has been deployed successfully!"
      - ""
      - "Access Grafana:"
      - "  Ingress: https://{{ grafana_ingress_host }}"
      - "  Port-forward: kubectl -n {{ grafana_namespace }} port-forward svc/grafana 3000:3000"
      - ""
      - "Login with the admin credentials you configured in the sealed secret"
      - ""
      - "Prometheus datasource has been automatically configured"
      - "Internal Prometheus URL: {{ grafana_prometheus_url }}"
