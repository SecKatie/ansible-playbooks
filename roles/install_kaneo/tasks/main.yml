---
- name: Create Kaneo namespace
  kubernetes.core.k8s:
    name: kaneo
    api_version: v1
    kind: Namespace
    state: present
    definition:
      metadata:
        labels:
          app.kubernetes.io/part-of: productivity
          app.kubernetes.io/managed-by: ansible
        annotations:
          app.kubernetes.io/description: "Kaneo project management namespace"

- name: Deploy Kaneo storage components
  kubernetes.core.k8s:
    state: present
    src: "{{ role_path }}/files/storage.yaml"

- name: Check if sealed secrets file exists
  ansible.builtin.stat:
    path: "{{ role_path }}/files/sealedsecrets.yaml"
  register: sealed_secrets_file

- name: Fail if sealed secrets not configured
  ansible.builtin.fail:
    msg:
      - "ERROR: Sealed secrets file not found at {{ role_path }}/files/sealedsecrets.yaml"
      - "Kaneo requires sealed secrets for database credentials and authentication."
      - ""
      - "To create the sealed secrets:"
      - "1. Create a raw secret file (never commit to Git):"
      - "   cat > /tmp/kaneo-secrets.yaml <<EOF"
      - "   apiVersion: v1"
      - "   kind: Secret"
      - "   metadata:"
      - "     name: kaneo-secrets"
      - "     namespace: kaneo"
      - "   type: Opaque"
      - "   stringData:"
      - '     postgres-user: "kaneo"'
      - '     postgres-password: "your-secure-password-here"'
      - '     database-url: "postgresql://kaneo:your-secure-password-here@kaneo-postgres.kaneo.svc.cluster.local:5432/kaneo"'
      - '     auth-secret: "your-jwt-secret-here-min-32-chars"'
      - "   EOF"
      - ""
      - "2. Seal the secret:"
      - "   kubeseal --format=yaml < /tmp/kaneo-secrets.yaml > {{ role_path }}/files/sealedsecrets.yaml"
      - ""
      - "3. Clean up the temporary file:"
      - "   rm /tmp/kaneo-secrets.yaml"
      - ""
      - "4. Run the playbook again"
  when: not sealed_secrets_file.stat.exists

- name: Deploy Kaneo sealed secrets
  kubernetes.core.k8s:
    state: present
    src: "{{ role_path }}/files/sealedsecrets.yaml"

- name: Deploy Kaneo application
  kubernetes.core.k8s:
    state: present
    src: "{{ role_path }}/files/kaneo.yaml"

- name: Wait for PostgreSQL to be ready
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: kaneo-postgres
    namespace: kaneo
    wait: true
    wait_condition:
      type: Available
      status: "True"
    wait_timeout: 300

- name: Wait for Kaneo API to be ready
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: kaneo-api
    namespace: kaneo
    wait: true
    wait_condition:
      type: Available
      status: "True"
    wait_timeout: 300

- name: Wait for Kaneo Web to be ready
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: kaneo-web
    namespace: kaneo
    wait: true
    wait_condition:
      type: Available
      status: "True"
    wait_timeout: 300

- name: Check if Cloudflare tunnel already exists
  ansible.builtin.shell: |
    cloudflared tunnel list --output json
  register: tunnel_list_result
  ignore_errors: true
  changed_when: false

- name: Initialize existing_tunnel variable
  ansible.builtin.set_fact:
    existing_tunnel: {}
  when: tunnel_list_result.rc != 0 or tunnel_list_result.stdout == ""

- name: Extract existing tunnel information
  ansible.builtin.set_fact:
    existing_tunnel: "{{ (tunnel_list_result.stdout | from_json) | selectattr('name', 'equalto', 'kaneo-tunnel') | list | first | default({}) }}"
  when: tunnel_list_result.rc == 0 and tunnel_list_result.stdout != ""

- name: Create Cloudflare tunnel if it doesn't exist
  ansible.builtin.shell: |
    cloudflared tunnel create kaneo-tunnel
  register: tunnel_create_result
  ignore_errors: true
  when: existing_tunnel == {}

- name: Set tunnel information from existing tunnel
  ansible.builtin.set_fact:
    tunnel_id: "{{ existing_tunnel.id }}"
    creds_path: "{{ ansible_env.HOME }}/.cloudflared/{{ existing_tunnel.id }}.json"
  when: existing_tunnel != {}

- name: Set tunnel information from newly created tunnel
  ansible.builtin.set_fact:
    tunnel_id: "{{ tunnel_create_result.stdout | regex_search('([a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12})', '\\1') | first }}"
    creds_path: "{{ tunnel_create_result.stdout | regex_search('(/.*?\\.json)', '\\1') | first }}"
  when: tunnel_create_result is defined and tunnel_create_result is not skipped and tunnel_create_result.rc == 0

- name: Check if tunnel credentials secret exists
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Secret
    name: kaneo-tunnel-credentials
    namespace: kaneo
  register: secret_check
  when: tunnel_id is defined and creds_path is defined

- name: Create or update tunnel credentials secret
  ansible.builtin.shell: |
    kubectl create secret generic kaneo-tunnel-credentials \
      --from-file=credentials.json="{{ creds_path }}" \
      --namespace=kaneo \
      --dry-run=client -o yaml | kubectl apply -f -
  register: secret_result
  when:
    - tunnel_id is defined
    - creds_path is defined
    - secret_check.resources | length == 0
  changed_when: true

- name: Deploy Cloudflare tunnel for Kaneo
  kubernetes.core.k8s:
    state: present
    src: "{{ role_path }}/files/cloudflared.yaml"

- name: Display deployment status
  ansible.builtin.debug:
    msg:
      - "Kaneo has been deployed successfully!"
      - ""
      - "Cloudflare tunnel configured:"
      - "   Tunnel ID: {{ tunnel_id }}"
      - "   Tunnel URL: {{ tunnel_id }}.cfargotunnel.com"
      - "   Status: {{ 'Using existing tunnel' if (existing_tunnel != {} and existing_tunnel is defined) else 'Created new tunnel' }} 'kaneo-tunnel'"
      - ""
      - "Next steps:"
      - "   1. Create DNS record: kaneo.mulliken.net -> {{ tunnel_id }}.cfargotunnel.com"
      - "   2. Access Kaneo at https://kaneo.mulliken.net"
      - ""
      - "Internal access:"
      - "   Web: http://kaneo-web.kaneo.svc.cluster.local:5173"
      - "   API: http://kaneo-api.kaneo.svc.cluster.local:1337"
  when: tunnel_id is defined

- name: Display deployment status (manual setup required)
  ansible.builtin.debug:
    msg:
      - "Kaneo has been deployed successfully!"
      - ""
      - "Manual tunnel setup required:"
      - "   1. Create a Cloudflare tunnel named 'kaneo-tunnel'"
      - "   2. Create the tunnel credentials secret:"
      - "      kubectl create secret generic kaneo-tunnel-credentials \\"
      - "        --from-file=credentials.json=/path/to/your/tunnel/credentials.json \\"
      - "        --namespace=kaneo"
      - "   3. Configure DNS record for kaneo.mulliken.net to point to your tunnel"
      - "   4. Access Kaneo at https://kaneo.mulliken.net"
      - ""
      - "Internal access:"
      - "   Web: http://kaneo-web.kaneo.svc.cluster.local:5173"
      - "   API: http://kaneo-api.kaneo.svc.cluster.local:1337"
  when: tunnel_id is not defined
