---
- name: Create Immich namespace
  kubernetes.core.k8s:
    name: "{{ immich_namespace }}"
    api_version: v1
    kind: Namespace
    state: present
    definition:
      metadata:
        labels:
          app.kubernetes.io/part-of: photos
          app.kubernetes.io/managed-by: ansible
        annotations:
          app.kubernetes.io/description: "Immich photo management namespace"

- name: Deploy Immich secrets
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'secret.yaml.j2') | from_yaml }}"

- name: Deploy Immich storage components
  kubernetes.core.k8s:
    state: present
    definition: "{{ item }}"
  loop: "{{ lookup('template', 'storage.yaml.j2') | from_yaml_all | list }}"

- name: Deploy Immich application components
  kubernetes.core.k8s:
    state: present
    definition: "{{ item }}"
  loop: "{{ lookup('template', 'immich.yaml.j2') | from_yaml_all | list }}"

- name: Wait for PostgreSQL to be ready
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: immich-postgres
    namespace: "{{ immich_namespace }}"
    wait: true
    wait_condition:
      type: Available
      status: "True"
    wait_timeout: 300

- name: Wait for Redis to be ready
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: immich-redis
    namespace: "{{ immich_namespace }}"
    wait: true
    wait_condition:
      type: Available
      status: "True"
    wait_timeout: 300

- name: Create TLS Certificate for Immich
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'certificate.yaml.j2') | from_yaml }}"
  when: immich_ingress_enabled | default(true)

- name: Wait for TLS certificate to be ready
  kubernetes.core.k8s_info:
    api_version: cert-manager.io/v1
    kind: Certificate
    name: "{{ immich_tls_secret_name }}"
    namespace: "{{ immich_namespace }}"
  register: cert_info
  until: >
    cert_info.resources | length > 0 and
    cert_info.resources[0].status.conditions | default([]) | selectattr('type', 'equalto', 'Ready') | selectattr('status', 'equalto', 'True') | list | length > 0
  retries: 30
  delay: 10
  when: immich_ingress_enabled | default(true)

- name: Deploy Immich Ingress
  kubernetes.core.k8s:
    state: present
    definition: "{{ item }}"
  loop: "{{ lookup('template', 'ingress.yaml.j2') | from_yaml_all | list }}"
  when: immich_ingress_enabled | default(true)

- name: Wait for Immich server deployment to be ready
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: immich-server
    namespace: "{{ immich_namespace }}"
    wait: true
    wait_condition:
      type: Available
      status: "True"
    wait_timeout: 600

- name: Wait for Immich ML deployment to be ready
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: immich-ml
    namespace: "{{ immich_namespace }}"
    wait: true
    wait_condition:
      type: Available
      status: "True"
    wait_timeout: 600
  when: immich_ml_enabled | default(true)

- name: Display deployment status
  ansible.builtin.debug:
    msg:
      - "Immich has been deployed successfully!"
      - ""
      - "Access:"
      - "   Web UI: https://{{ immich_ingress_host }}"
      - "   Service: http://immich-server.{{ immich_namespace }}.svc.cluster.local:2283"
      - ""
      - "Components:"
      - "   Server: {{ immich_server_image }}:{{ immich_version }}"
      - "   ML: {{ immich_ml_image }}:{{ immich_version }} ({{ 'enabled' if immich_ml_enabled | default(true) else 'disabled' }})"
      - "   PostgreSQL: {{ immich_postgres_image }}:{{ immich_postgres_version }}"
      - "   Redis: {{ immich_redis_image }}:{{ immich_redis_version }}"
      - ""
      - "Storage:"
      - "   Library: NFS at {{ immich_nfs_path }} ({{ immich_nfs_storage }})"
      - "   PostgreSQL: {{ immich_storage_class }} ({{ immich_postgres_storage }})"
      - "   ML Cache: {{ immich_storage_class }} ({{ immich_ml_cache_storage }})"
      - ""
      - "First-time setup:"
      - "   1. Open https://{{ immich_ingress_host }}"
      - "   2. Create your admin account"
      - "   3. Download the mobile app and connect to this server"
