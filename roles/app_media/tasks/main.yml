---
- name: Create media namespace
  ansible.builtin.include_role:
    name: common_k8s
    tasks_from: namespace
  vars:
    k8s_namespace: "{{ media_namespace }}"
    k8s_labels:
      app.kubernetes.io/name: media
      app.kubernetes.io/part-of: media

- name: Deploy VPN secrets
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'secret.yaml.j2') | from_yaml }}"

- name: Deploy NFS storage components
  kubernetes.core.k8s:
    state: present
    definition: "{{ item }}"
  loop: "{{ lookup('template', 'storage.yaml.j2') | from_yaml_all | list }}"

- name: Create config PVCs (Sonarr/Radarr/qBittorrent/Jackett/SABnzbd)
  ansible.builtin.include_role:
    name: common_k8s
    tasks_from: storage
  loop:
    - name: sonarr
      pvc: sonarr-config-pvc
      size: "{{ sonarr_config_storage }}"
    - name: qbittorrent
      pvc: qbittorrent-config-pvc
      size: "{{ qbittorrent_config_storage }}"
    - name: jackett
      pvc: jackett-config-pvc
      size: "{{ jackett_config_storage }}"
    - name: radarr
      pvc: radarr-config-pvc
      size: "{{ radarr_config_storage }}"
    - name: sabnzbd
      pvc: sabnzbd-config-pvc
      size: "{{ sabnzbd_config_storage }}"
  loop_control:
    loop_var: pvc_item
  vars:
    k8s_namespace: "{{ media_namespace }}"
    k8s_pvc_name: "{{ pvc_item.pvc }}"
    k8s_pvc_size: "{{ pvc_item.size }}"
    k8s_pvc_storage_class: "{{ media_storage_class }}"
    k8s_labels:
      app.kubernetes.io/name: "{{ pvc_item.name }}"
      app.kubernetes.io/part-of: media
      app.kubernetes.io/component: storage

- name: Deploy downloads stack (VPN protected)
  kubernetes.core.k8s:
    state: present
    definition: "{{ item }}"
  loop: "{{ lookup('template', 'downloads.yaml.j2') | from_yaml_all | list }}"

- name: Deploy Sonarr application
  kubernetes.core.k8s:
    state: present
    definition: "{{ item }}"
  loop: "{{ lookup('template', 'sonarr-app.yaml.j2') | from_yaml_all | list }}"

- name: Deploy Radarr application
  kubernetes.core.k8s:
    state: present
    definition: "{{ item }}"
  loop: "{{ lookup('template', 'radarr-app.yaml.j2') | from_yaml_all | list }}"

- name: Create TLS Certificate for media services
  ansible.builtin.include_role:
    name: common_k8s
    tasks_from: certificate
  vars:
    k8s_namespace: "{{ media_namespace }}"
    k8s_cert_name: "{{ media_tls_secret_name }}"
    k8s_cert_secret_name: "{{ media_tls_secret_name }}"
    k8s_cert_dns_names:
      - "{{ sonarr_ingress_host }}"
      - "{{ radarr_ingress_host }}"
      - "{{ jackett_ingress_host }}"
      - "{{ qbittorrent_ingress_host }}"
      - "{{ sabnzbd_ingress_host }}"
    k8s_labels:
      app.kubernetes.io/name: media
      app.kubernetes.io/part-of: media
  when: media_ingress_enabled | default(true)

- name: Wait for TLS certificate to be ready
  kubernetes.core.k8s_info:
    api_version: cert-manager.io/v1
    kind: Certificate
    name: "{{ media_tls_secret_name }}"
    namespace: "{{ media_namespace }}"
  register: cert_info
  until: >
    cert_info.resources | length > 0 and
    cert_info.resources[0].status.conditions | default([]) | selectattr('type', 'equalto', 'Ready') | selectattr('status', 'equalto', 'True') | list | length > 0
  retries: 30
  delay: 10
  when: media_ingress_enabled | default(true)

- name: Create ingress resources for media apps
  ansible.builtin.include_role:
    name: common_k8s
    tasks_from: ingress
  loop:
    - name: sonarr
      host: "{{ sonarr_ingress_host }}"
      service: sonarr
      port: 8989
    - name: radarr
      host: "{{ radarr_ingress_host }}"
      service: radarr
      port: 7878
    - name: jackett
      host: "{{ jackett_ingress_host }}"
      service: downloads
      port: 9117
    - name: qbittorrent
      host: "{{ qbittorrent_ingress_host }}"
      service: downloads
      port: 8080
    - name: sabnzbd
      host: "{{ sabnzbd_ingress_host }}"
      service: downloads
      port: 8085
  loop_control:
    loop_var: ingress_item
  vars:
    k8s_namespace: "{{ media_namespace }}"
    k8s_ingress_name: "{{ ingress_item.name }}"
    k8s_ingress_host: "{{ ingress_item.host }}"
    k8s_ingress_service_name: "{{ ingress_item.service }}"
    k8s_ingress_service_port: "{{ ingress_item.port }}"
    k8s_ingress_tls_secret: "{{ media_tls_secret_name }}"
    k8s_labels:
      app.kubernetes.io/name: media
      app.kubernetes.io/part-of: media
  when: media_ingress_enabled | default(true)

- name: Wait for downloads deployment to be ready
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: downloads
    namespace: "{{ media_namespace }}"
    wait: true
    wait_condition:
      type: Available
      status: "True"
    wait_timeout: 600

- name: Wait for Sonarr deployment to be ready
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: sonarr
    namespace: "{{ media_namespace }}"
    wait: true
    wait_condition:
      type: Available
      status: "True"
    wait_timeout: 300

- name: Wait for Radarr deployment to be ready
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: radarr
    namespace: "{{ media_namespace }}"
    wait: true
    wait_condition:
      type: Available
      status: "True"
    wait_timeout: 300

- name: Get VPN public IP
  ansible.builtin.shell: |
    kubectl exec -n {{ media_namespace }} deployment/downloads -c gluetun -- wget -qO- http://localhost:8000/v1/publicip/ip
  register: vpn_ip_result
  ignore_errors: true
  changed_when: false

- name: Display deployment status
  ansible.builtin.debug:
    msg:
      - "Media stack has been deployed successfully!"
      - ""
      - "VPN Status (Downloads Pod):"
      - "   Provider: Mullvad WireGuard"
      - "   VPN Public IP: {{ vpn_ip_result.stdout | default('Unable to retrieve - check pod logs') }}"
      - "   Protected services: qBittorrent, SABnzbd, Jackett, FlareSolverr"
      - ""
      - "Sonarr (TV Shows) - NO VPN:"
      - "   Ingress: https://{{ sonarr_ingress_host }}"
      - "   Internal: http://sonarr.{{ media_namespace }}.svc.cluster.local:8989"
      - "   Port Forward: kubectl -n {{ media_namespace }} port-forward svc/sonarr 8989:8989"
      - ""
      - "Radarr (Movies) - NO VPN:"
      - "   Ingress: https://{{ radarr_ingress_host }}"
      - "   Internal: http://radarr.{{ media_namespace }}.svc.cluster.local:7878"
      - "   Port Forward: kubectl -n {{ media_namespace }} port-forward svc/radarr 7878:7878"
      - ""
      - "Downloads Stack - WITH VPN:"
      - "   qBittorrent: https://{{ qbittorrent_ingress_host }}"
      - "   SABnzbd: https://{{ sabnzbd_ingress_host }}"
      - "   Jackett: https://{{ jackett_ingress_host }}"
      - ""
      - "SABnzbd First-Run Setup Required:"
      - "   SABnzbd defaults to port 8080 which conflicts with qBittorrent."
      - "   After deployment, configure SABnzbd to use port 8085:"
      - "   1. kubectl exec -n {{ media_namespace }} deployment/downloads -c sabnzbd -- sed -i 's/port = 8080/port = 8085/' /config/sabnzbd.ini"
      - "   2. kubectl exec -n {{ media_namespace }} deployment/downloads -c sabnzbd -- sed -i 's/host = 127.0.0.1/host = 0.0.0.0/' /config/sabnzbd.ini"
      - "   3. kubectl rollout restart -n {{ media_namespace }} deployment/downloads"
      - ""
      - "Storage:"
      - "   Configs: {{ media_storage_class }} storage"
      - "   Media: NFS storage at {{ media_nfs_path }} (shared with Jellyfin)"
      - ""
      - "Configure Sonarr/Radarr to use:"
      - "   qBittorrent: downloads.{{ media_namespace }}.svc.cluster.local:8080"
      - "   SABnzbd: downloads.{{ media_namespace }}.svc.cluster.local:8085"
      - "   Jackett: downloads.{{ media_namespace }}.svc.cluster.local:9117"
      - "   Download paths: /media/downloads"
      - "   TV shows path: /media/tv"
      - "   Movies path: /media/movies"
