---
- name: Create Jellyfin namespace
  kubernetes.core.k8s:
    name: jellyfin
    api_version: v1
    kind: Namespace
    state: present
    definition:
      metadata:
        labels:
          app.kubernetes.io/part-of: media
          app.kubernetes.io/managed-by: ansible
        annotations:
          app.kubernetes.io/description: "Jellyfin media server namespace"

- name: Deploy Jellyfin storage components
  kubernetes.core.k8s:
    state: present
    src: "{{ role_path }}/files/storage.yaml"

- name: Deploy Jellyfin application
  kubernetes.core.k8s:
    state: present
    src: "{{ role_path }}/files/jellyfin.yaml"

- name: Deploy Jellyfin ingress
  kubernetes.core.k8s:
    state: present
    src: "{{ role_path }}/files/ingress.yaml"

- name: Setup Cloudflare tunnel
  ansible.builtin.include_role:
    name: setup_cloudflare_tunnel
  vars:
    cf_tunnel_name: jellyfin-tunnel
    cf_tunnel_namespace: jellyfin
    cf_tunnel_secret_name: jellyfin-tunnel-credentials

- name: Deploy Cloudflare tunnel for Jellyfin
  kubernetes.core.k8s:
    state: present
    src: "{{ role_path }}/files/cloudflared.yaml"
  when: cf_tunnel_configured | default(false)

- name: Wait for Jellyfin deployment to be ready
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: jellyfin
    namespace: jellyfin
    wait: true
    wait_condition:
      type: Available
      status: "True"
    wait_timeout: 600

- name: Display deployment status
  ansible.builtin.debug:
    msg:
      - "Jellyfin has been deployed successfully!"
      - ""
      - "Cloudflare tunnel configured:"
      - "   Tunnel ID: {{ cf_tunnel_id }}"
      - "   Tunnel URL: {{ cf_tunnel_id }}.cfargotunnel.com"
      - "   Status: {{ 'Using existing tunnel' if cf_tunnel_status == 'existing' else 'Created new tunnel' }} 'jellyfin-tunnel'"
      - ""
      - "Next steps:"
      - "   1. Create DNS record: jellyfin.mulliken.net -> {{ cf_tunnel_id }}.cfargotunnel.com"
      - "   2. Access Jellyfin at https://jellyfin.mulliken.net"
      - ""
      - "Internal access: http://jellyfin.jellyfin.svc.cluster.local:8096"
  when: cf_tunnel_configured | default(false)

- name: Display deployment status (manual setup required)
  ansible.builtin.debug:
    msg:
      - "Jellyfin has been deployed successfully!"
      - ""
      - "Manual tunnel setup required:"
      - "   1. Create a Cloudflare tunnel named 'jellyfin-tunnel'"
      - "   2. Create the tunnel credentials secret:"
      - "      kubectl create secret generic jellyfin-tunnel-credentials \\"
      - "        --from-file=credentials.json=/path/to/your/tunnel/credentials.json \\"
      - "        --namespace=jellyfin"
      - "   3. Configure DNS record for jellyfin.mulliken.net to point to your tunnel"
      - "   4. Access Jellyfin at https://jellyfin.mulliken.net"
      - ""
      - "Internal access: http://jellyfin.jellyfin.svc.cluster.local:8096"
  when: not (cf_tunnel_configured | default(false))
