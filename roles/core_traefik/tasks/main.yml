---
- name: Deploy Cloudflare API token secret
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'secret.yaml.j2') | from_yaml }}"

- name: Create wildcard certificate for Gateway
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'certificate.yaml.j2') | from_yaml }}"

- name: Wait for certificate to be issued
  kubernetes.core.k8s_info:
    api_version: cert-manager.io/v1
    kind: Certificate
    name: wildcard-corp-tls
    namespace: kube-system
  register: cert_status
  until: >
    cert_status.resources | length > 0 and
    (cert_status.resources[0].status.conditions | default([]) | selectattr('type', 'equalto', 'Ready') | selectattr('status', 'equalto', 'True') | list | length > 0)
  retries: 30
  delay: 10

- name: Apply Traefik HelmChartConfig for ACME
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'traefik-config.yml.j2') | from_yaml }}"

- name: Wait for Traefik to restart with new configuration
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: traefik
    namespace: kube-system
  register: traefik_deploy
  until: >
    traefik_deploy.resources | length > 0 and
    traefik_deploy.resources[0].status.readyReplicas | default(0) == traefik_deploy.resources[0].spec.replicas
  retries: 30
  delay: 10

- name: Display ACME configuration information
  ansible.builtin.debug:
    msg:
      - "Traefik ACME configuration applied successfully!"
      - ""
      - "Configuration:"
      - "   - Certificate resolver: {{ traefik_acme_resolver }}"
      - "   - ACME email: {{ traefik_acme_email }}"
      - "   - Domain: *.{{ traefik_acme_domain }}"
      - ""
      - "To use Let's Encrypt certs in your IngressRoutes, add:"
      - "   tls:"
      - "     certResolver: {{ traefik_acme_resolver }}"
      - "     domains:"
      - "       - main: {{ traefik_acme_domain }}"
      - "         sans:"
      - "           - '*.{{ traefik_acme_domain }}'"
