---
- name: Create Cloudflare DNS A record for Uptime Kuma
  community.general.cloudflare_dns:
    zone: "{{ uptime_kuma_cloudflare_zone }}"
    record: "{{ uptime_kuma_domain.split('.')[0] }}"
    type: A
    value: "{{ ansible_host }}"
    proxied: true
    solo: true
    api_token: "{{ cloudflare_api_token }}"
    state: present
  delegate_to: localhost
  become: false

- name: Create Uptime Kuma directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - "{{ uptime_kuma_data_dir }}"
    - "{{ uptime_kuma_data_dir }}/data"
    - "{{ uptime_kuma_data_dir }}/caddy"

- name: Deploy Uptime Kuma docker-compose.yml
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ uptime_kuma_data_dir }}/docker-compose.yml"
    mode: "0644"
  register: uptime_kuma_compose

- name: Start Uptime Kuma
  community.docker.docker_compose_v2:
    project_src: "{{ uptime_kuma_data_dir }}"
    state: present
    pull: always
  register: uptime_kuma_started

- name: Restart Uptime Kuma if compose file changed
  community.docker.docker_compose_v2:
    project_src: "{{ uptime_kuma_data_dir }}"
    state: restarted
  when: uptime_kuma_compose.changed and not uptime_kuma_started.changed

- name: Display Uptime Kuma access information
  ansible.builtin.debug:
    msg: |
      Uptime Kuma deployed successfully!

      Access via: https://{{ uptime_kuma_domain }}

      Data directory: {{ uptime_kuma_data_dir }}/data

      To view logs:
        docker logs -f {{ uptime_kuma_container_name }}
        docker logs -f caddy
