---
- name: Disable IPv6 on Raspberry Pi nodes
  hosts: raspberrypi
  gather_facts: true
  become: true

  tasks:
    - name: Disable IPv6 via sysctl
      ansible.posix.sysctl:
        name: "{{ item }}"
        value: '1'
        state: present
        reload: true
        sysctl_file: /etc/sysctl.d/99-disable-ipv6.conf
      loop:
        - net.ipv6.conf.all.disable_ipv6
        - net.ipv6.conf.default.disable_ipv6
        - net.ipv6.conf.lo.disable_ipv6

    - name: Verify IPv6 is disabled
      ansible.builtin.shell: cat /proc/sys/net/ipv6/conf/all/disable_ipv6
      register: ipv6_status
      changed_when: false

    - name: Display IPv6 status
      ansible.builtin.debug:
        msg: "IPv6 disabled: {{ ipv6_status.stdout == '1' }}"

    - name: Check if k3s server service exists
      ansible.builtin.systemd:
        name: k3s
      register: k3s_server_status
      ignore_errors: true

    - name: Restart k3s server to apply changes
      ansible.builtin.systemd:
        name: k3s
        state: restarted
      when:
        - ipv6_status.stdout == '1'
        - k3s_server_status.status.LoadState is defined
        - k3s_server_status.status.LoadState == 'loaded'

    - name: Restart k3s agent to apply changes
      ansible.builtin.systemd:
        name: k3s-agent
        state: restarted
      when:
        - ipv6_status.stdout == '1'
        - k3s_server_status.failed | default(false)

    - name: Wait for k3s to be ready
      ansible.builtin.wait_for:
        port: 6443
        delay: 10
        timeout: 60
      when:
        - ipv6_status.stdout == '1'
        - k3s_server_status.status.LoadState is defined
        - k3s_server_status.status.LoadState == 'loaded'
