---
# =============================================================================
# Portainer Uninstall Playbook
# =============================================================================
# This playbook removes Portainer from the Kubernetes cluster
#
# Usage:
#   ansible-playbook -i inventory/hosts.yml playbooks/uninstall_portainer.yml
#
# What this playbook does:
#   1. Uninstalls Portainer Helm release
#   2. Removes Portainer namespace
#   3. Removes Portainer Helm repository (optional)
# =============================================================================

- name: Uninstall Portainer from Kubernetes
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    portainer_namespace: portainer
    portainer_release_name: portainer
    portainer_helm_repo_name: portainer
    remove_helm_repo: false  # Set to true to also remove the Helm repo

  tasks:
    - name: Check if Portainer Helm release exists
      ansible.builtin.command:
        cmd: helm status {{ portainer_release_name }} -n {{ portainer_namespace }}
      register: helm_status
      failed_when: false
      changed_when: false

    - name: Uninstall Portainer Helm release
      ansible.builtin.command:
        cmd: helm uninstall {{ portainer_release_name }} -n {{ portainer_namespace }}
      when: helm_status.rc == 0
      register: helm_uninstall

    - name: Display Helm uninstall result
      ansible.builtin.debug:
        msg: "Portainer Helm release uninstalled successfully"
      when: helm_uninstall is changed

    - name: Check if Portainer namespace exists
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Namespace
        name: "{{ portainer_namespace }}"
      register: namespace_info

    - name: Wait for Portainer pods to terminate
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Pod
        namespace: "{{ portainer_namespace }}"
      register: pod_info
      until: pod_info.resources | length == 0
      retries: 30
      delay: 5
      when: namespace_info.resources | length > 0

    - name: Delete Portainer namespace
      kubernetes.core.k8s:
        api_version: v1
        kind: Namespace
        name: "{{ portainer_namespace }}"
        state: absent
        wait: true
        wait_timeout: 300
      when: namespace_info.resources | length > 0

    - name: Remove Portainer Helm repository
      ansible.builtin.command:
        cmd: helm repo remove {{ portainer_helm_repo_name }}
      register: repo_remove
      failed_when: false
      changed_when: repo_remove.rc == 0
      when: remove_helm_repo | bool

    - name: Display completion message
      ansible.builtin.debug:
        msg:
          - "=============================================="
          - "Portainer has been removed successfully!"
          - "=============================================="
          - ""
          - "Removed components:"
          - "  ✓ Portainer Helm release"
          - "  ✓ Portainer namespace ({{ portainer_namespace }})"
          - "  ✓ All Portainer pods and services"
          - "  {{ '✓ Portainer Helm repository' if (remove_helm_repo | bool) else '- Helm repository kept (use -e remove_helm_repo=true to remove)' }}"
          - ""
          - "Next steps:"
          - "  - Update Homepage configuration if needed"
          - "  - Remove Portainer role from playbooks if not needed"
