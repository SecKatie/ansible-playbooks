---
- name: Update all packages on all systems
  hosts: all
  become: yes
  gather_facts: yes
  serial: "{{ update_serial | default('100%') }}"
  
  vars:
    # Update configuration
    auto_reboot: false
    reboot_delay: 30
    # Notification configuration
    ntfy_topic: "{{ ntfy_update_topic | default('ee4ccfad-efdb-4862-8f38-d7455bcbd198') }}"
    ntfy_auth: "{{ ntfy_update_auth | default(omit) }}"
    
  pre_tasks:
    - name: Display system information
      debug:
        msg: |
          Updating packages on {{ inventory_hostname }}
          OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
          Architecture: {{ ansible_architecture }}
          Package Manager: {{ ansible_pkg_mgr }}

  tasks:
    - block:
        - name: Run system update
          include_role:
            name: system_update

        - name: Display completion message
          debug:
            msg: "Package update completed on {{ inventory_hostname }}"
            
        - name: Reboot notification
          debug:
            msg: |
              âš ï¸  ATTENTION: {{ inventory_hostname }} requires a reboot to complete the update.
              You can reboot manually or run the reboot playbook: ansible-playbook playbooks/maintenance-reboot-systems.yml
          when: reboot_required is defined and reboot_required|bool

      rescue:
        - name: Display update failure
          debug:
            msg: "âŒ Package update failed on {{ inventory_hostname }}"

        - name: Re-raise the failure
          fail:
            msg: "Update failed on {{ inventory_hostname }}"

  handlers:
    - name: reboot system
      reboot:
        reboot_timeout: 600
        connect_timeout: 20
        test_command: uptime
      when: auto_reboot|bool and (reboot_required is defined and reboot_required|bool)

# Summary play (runs after all hosts are processed)
- name: Display update summary
  hosts: localhost
  connection: local
  gather_facts: true

  tasks:
    - name: Display update summary
      debug:
        msg: |
          ðŸ“Š Update Summary Report

          Total servers: {{ groups['all'] | length }}
          Completed: {{ ansible_play_hosts_all | default([]) | length }}
          Time: {{ ansible_date_time.iso8601 }}

          {% if hostvars | dict2items | selectattr('value.reboot_required', 'defined') | selectattr('value.reboot_required') | list | length > 0 %}
          Servers requiring reboot:
          {% for host in groups['all'] %}
          {% if hostvars[host].reboot_required is defined and hostvars[host].reboot_required %}
          - {{ host }}
          {% endif %}
          {% endfor %}
          {% endif %} 